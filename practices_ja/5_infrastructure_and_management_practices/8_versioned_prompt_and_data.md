# Versioned Prompt and DB

## 概要

Versioned Prompt and DBは、LLMアプリケーションにおけるプロンプトとデータの両方にバージョン管理を導入し、システム全体の再現性と品質を担保する設計プラクティスです。このプラクティスにより、プロンプトの変更履歴とデータの状態を追跡し、検索結果の再現性を確保しながら、継続的な改善を実現することができます。特に、埋め込みモデルの更新や複数モデルの併用、長期運用を前提とするシステムでは不可欠な設計要素となります。

## 解決したい課題

多くのソフトウェアシステムは永続化データとプログラムを持ち、その両方とも変化します。顧客データは時間とともに変化するでしょうし、顧客データを扱うプログラムに修正が入ることも時々あるでしょう。

LLMアプリケーションで扱うプロンプトやデータも同様に変化します。プロンプトの変化はLLMアプリケーションが提供する品質や体験を左右します。プロンプトの変更によって品質改善されることもあれば、それまで体験できていたことが体験できなくなる可能性もあるでしょう。プロンプトの変更が悪い結果をもたらす場合、どのタイミングの変更がその契機になっているのか、変更ログから追っていき、必要に応じてRevertや修正することが一般的でしょう。LLMアプリケーションで扱うデータも同様です。特にプロンプトのコンテキストとして利用するようなログや履歴は時間とともに追加されていきますが、そうしたデータは多くの場合、ベクトルストアや検索システムに格納されます。LLMアプリケーションはプロンプトを組み立てるために過去のログや履歴を参照するため、ベクトルストアや検索システムのデータが変更されることで、それまで提供できていた情報や体験が提供できなくなる可能性があります。プロンプトの変更と同様に、どの時点の変更（ログや履歴の追加）がその契機となっているのか、追っていくことが重要です。

1. **プロンプトの変更が予期せぬ結果を招く**
   - 例：既存のワークフローで使用されていたプロンプトを改善しようとしたところ、以前は成功していた出力が失敗するようになりました。

2. **検索結果の再現性がない**
   - 例：1週間前に実行した検索クエリの結果が、現在では異なる結果を返してしまう。

3. **モデルアップデートによる不整合**
   - 例：OpenAIのtext-embedding-ada-002からtext-embedding-3-smallに更新した際、古いベクトルデータと新しいベクトルデータが混在して検索精度が低下。

4. **A/Bテストや分析が困難**
   - 例：異なる埋め込みモデルやプロンプトの性能比較を行う際、同じデータセットでの公平な比較が困難。

5. **障害復旧時のデータ損失**
   - 例：DBのクラスタがクラッシュした際、最新の状態しか復元できず、過去の検索結果が再現できない。

## 解決策

この課題を解決するために、プロンプトとデータの両方にバージョン管理の概念を導入します。

### プロンプトのバージョン管理

1. **すべてのプロンプトにバージョンIDを付与**
   - プロンプトを文字列やテンプレートとして管理する際に、明示的なバージョンを付けて保存します。

2. **バージョン単位でプロンプトを保存・呼び出し**
   - 各バージョンごとのプロンプトをストレージに保存し、呼び出し時にバージョンを指定して再現可能な状態にします。

3. **バージョンごとのテスト・評価**
   - A/Bテストや品質評価をバージョン単位で実施することで、安全にプロンプト改善を試みることができます。

### データのスナップショット管理

1. **スナップショットの保存方法**
   - ファイルシステム上に保存（例：Parquet、JSON、Pickle）
   - オブジェクトストレージ（例：S3）へのアップロード
   - バージョン付きのベクトルデータインデックスを別インスタンスで保持

2. **スナップショットの内容**
   - データ
   - 関連メタデータ
   - 作成日時
   - 使用したモデルの情報
   - インデックス設定

3. **復元プロセス**
   - 保存されたスナップショットをもとにデータベースを再構成
   - 必要に応じて特定の時点の状態を復元

## 適応するシーン

このプラクティスは以下のような状況で有効です。

- 高信頼性が求められるLLMアプリケーション
- 検索結果の再現性を保証する必要がある分析や報告用途
- 異なるモデル間の比較実験を行いたい場合
- 過去の検索精度やデータ分布のトラッキングを行いたい場合
- 監査やコンプライアンス要件があるシステム
- 組織内で複数チームが同じLLMアプリケーションを開発・運用している場合

## 利用するメリット

このプラクティスを導入することで、以下の利点があります。

- プロンプトとデータの両方の再現性が担保され、監査や不具合検証が容易になります。
- モデルの更新によるベクトルデータの変化を定量的に把握できます。
- 障害発生時に過去の正常な状態へ復元できます。
- 時系列に沿った検索品質や構成の変化を定量的に分析可能です。
- 異なるモデルや設定での実験が容易になります。
- プロンプト改善を安全かつ継続的に進めることができます。
- バージョンごとの差分管理によってナレッジが蓄積されます。

## 注意点とトレードオフ

このプラクティスには以下の注意点があります。

- **ストレージコスト**
  - スナップショットの保存に追加のストレージが必要になります。
  - 例：1TBのデータを日次でスナップショット取得する場合、月間30TBのストレージが必要。

- **スナップショット作成の処理負荷**
  - ベクトルデータ数が多い場合はスナップショット作成に時間と計算リソースを要します。
  - 例：1000万件のデータのスナップショット作成に数時間を要する場合がある。

- **管理対象の増加**
  - バージョンが増えるとプロンプトとデータの管理が煩雑になるため、命名規則や運用ルールを明確に定義する必要があります。

- **実装と運用のコスト**
  - バージョン付きプロンプトの呼び出しロジックや保存先の設計・実装が必要になります。

## 導入のヒント

導入にあたっては以下のような工夫が有効です。

1. **定期バックアップの自動化**
   - バッチ処理で日次・週次など定期的にスナップショットを取得します。
   - 例：cronジョブで毎日深夜にスナップショットを取得。

2. **モデルバージョンとセットで管理**
   - スナップショットには必ず使用モデルのIDやハッシュを含め、後から同条件で復元できるようにします。
   - 例：モデルバージョンとスナップショットIDの紐付け管理。

3. **テンプレート化されたプロンプトの活用**
   - JinjaやMustacheなどのテンプレートエンジンを使用することで、差分管理がしやすくなります。

4. **モニタリングとバージョン管理**
   - どの時点のスナップショットがどの結果に対応するかを明確に管理します。
   - 例：スナップショット管理用のダッシュボードの作成。

5. **YAMLやJSON形式での管理**
   - プロンプトとバージョンの管理をYAMLやJSON形式で行うことで、他の構成管理と統一しやすくなります。

## まとめ

Versioned Prompt and DBは、LLMアプリケーションの信頼性・再現性・可観測性を向上させるための有効なアプローチです。プロンプトとデータの両方にバージョン管理を導入することで、システム全体の品質を担保しながら、継続的な改善を実現することができます。適切な保存・復元戦略とともに導入することで、LLMシステムの運用性と品質保証を強化できます。ただし、ストレージコストや処理負荷などのトレードオフを考慮した上で、システムの要件に応じた適切な実装を行うことが重要です。

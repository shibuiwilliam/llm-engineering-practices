# Prompt Engineering Patterns

## グループ概要

**Prompt Engineering Patterns** は、LLM のプロンプトを"設計・生成・組み立て・最適化"するための体系です。  
LLM はプロンプト設計の巧拙で出力品質・コスト・レイテンシが大きく変動します。本グループのパターンを適用することで、明確で再利用性の高いプロンプト設計と、継続的な改善サイクルを構築できます。

### 主なユースケース
| ユースケース | 目的 | 使用される代表パターン |
|--------------|------|-------------------------|
| ドキュメント大量要約バッチ | トークン節約・並列処理 | Prompt Splitting / Sharding |
| FAQ チャットボット | 出力一貫性・改修容易化 | Structured Prompt Template / Prompt Inheritance |
| 高信頼性レポート生成 | 品質向上・自己修正 | Self‑Reflection Prompt |
| ブレインストーム補助ツール | 多視点検討・軌道修正 | Parallel World / Forget Past |

---

## パターン詳細

### 1. Prompt Inheritance Pattern
| 項目 | 内容 |
|------|------|
| **説明** | 基本プロンプト（ベースクラス）を継承し、特定タスク用サブプロンプトで追加・上書きする階層型テンプレート設計。 |
| **用途** | 同系統タスク（例: 製品カテゴリ別 FAQ）で共通構文を再利用しつつ局所カスタムしたい場合。 |
| **解決課題** | コピペで大量プロンプトを複製 → 修正漏れ・不整合が発生する問題。 |
| **対象システム** | マルチドメイン FAQ ボット、SaaS テナント別アプリ。 |
| **メリット** | DRY原則順守、変更を親テンプレに集約。 |
| **注意点** | 継承階層が深すぎると可読性が低下。 |

---

### 2. Structured Prompt Template Pattern
| 項目 | 内容 |
|------|------|
| **説明** | YAML/JSON など構造化フォーマットでテンプレートを定義し、変数バインドでプロンプトを生成する。 |
| **用途** | 入力値を埋め込んだ定型応答・生成。 |
| **解決課題** | 自然文テンプレート直書きによるパラメータ埋込ミス。 |
| **対象システム** | 請求書自動作成・カスタムメール生成。 |
| **メリット** | 変数とテキスト分離で誤植を防止、機械可読。 |
| **注意点** | 複雑すぎるネストはテンプレ管理を難化させる。 |

---

### 3. Interpreter Pattern for Prompt Templates
| 項目 | 内容 |
|------|------|
| **説明** | テンプレート内にミニ DSL を定義し、実行時にパース・解釈してプロンプトを生成する。 |
| **用途** | 条件分岐・ループを含む高度な動的プロンプト。 |
| **解決課題** | 複雑な if/else をコード側に大量記述する混乱。 |
| **対象システム** | マルチ言語応答生成、可変セクション付きレポート。 |
| **メリット** | テンプレ側でロジック完結、コード側は簡潔。 |
| **注意点** | DSL の学習コスト・パフォーマンスに注意。 |

---

### 4. Builder for Prompt Assembly Pattern
| 項目 | 内容 |
|------|------|
| **説明** | プロンプトをセクション部品に分け、ビルダーチェーンで段階的に組み立てる。 |
| **用途** | オプションごとにヘッダ/本文/例示を付与する生成。 |
| **解決課題** | if 文だらけの文字列連結スパゲティ。 |
| **対象システム** | API ドキュメント生成、条件付き Q&A。 |
| **メリット** | 可読性・テスト性向上、拡張が容易。 |
| **注意点** | ビルダー階層が深いと追跡が困難。 |

---

### 5. Prompt Splitting and Aggregation Pattern
| 項目 | 内容 |
|------|------|
| **説明** | 長文や大量レコードをチャンクに分割して個別推論後、結果を統合。 |
| **用途** | 長文要約、大規模データ抽出。 |
| **解決課題** | トークン制限超過によるエラー。 |
| **対象システム** | 一括文書解析、議事録作成。 |
| **メリット** | トークン節約、部分失敗時の再試行が容易。 |
| **注意点** | 統合ロジック設計を誤ると整合性欠如。 |

---

### 6. Prompt Sharding Pattern
| 項目 | 内容 |
|------|------|
| **説明** | データセットを水平分割し複数スレッド/ワーカーで並列推論後に結合しスループットを上げる。 |
| **用途** | 大規模バッチ分類・要約。 |
| **解決課題** | 単一リクエスト処理のスケール限界。 |
| **対象システム** | クラウドバッチパイプライン。 |
| **メリット** | 処理時間短縮、コスト効率改善。 |
| **注意点** | シャード間の重複・欠損データ管理が必要。 |

---

### 7. Self‑Reflection Prompt Pattern
| 項目 | 内容 |
|------|------|
| **説明** | 応答後に LLM 自身へ評価/修正を促す追加プロンプトを自動付加し品質を高める。 |
| **用途** | レポート生成、推論結果の自己検証。 |
| **解決課題** | ハルシネーションやロジック穴の放置。 |
| **対象システム** | 医療サマリー、規制文書下書き。 |
| **メリット** | 自律的な品質向上、二重チェック効果。 |
| **注意点** | 反省プロンプト自体のバイアスリスク。 |

---

### 8. Forget Past Pattern
| 項目 | 内容 |
|------|------|
| **説明** | 会話を任意ポイントにロールバックし、不要履歴をカットして議論を再開。 |
| **用途** | 迷走した対話のリセット。 |
| **解決課題** | 無駄な履歴でコンテキスト汚染、トークン浪費。 |
| **対象システム** | ブレインストーム、学習支援。 |
| **メリット** | トークン節約、議論精度回復。 |
| **注意点** | ロールバック基準を誤ると必要情報も消える。 |

---

### 9. Parallel World Pattern
| 項目 | 内容 |
|------|------|
| **説明** | 同一履歴をコピーし複数方向に並列検討し、結果を比較評価する。 |
| **用途** | アイデア創出、仮説比較。 |
| **解決課題** | 1つの案に固執し多様性が欠如。 |
| **対象システム** | 企画立案支援、研究補助。 |
| **メリット** | 多角的検討・創造性向上。 |
| **注意点** | セッション管理が煩雑、コスト増。 |

---

### 10. User Environment Pattern
| 項目 | 内容 |
|------|------|
| **説明** | ユーザーの時間・場所・属性・天気など環境情報を動的挿入し、状況適応応答を得る。 |
| **用途** | パーソナライズドコンシェルジュ。 |
| **解決課題** | 単調で文脈無視の応答。 |
| **対象システム** | 旅行ガイドAI、eコマースアシスタント。 |
| **メリット** | 応答の関連性と満足度向上。 |
| **注意点** | プライバシー保護・GDPR等規制対応が必須。 |

---

## アンチパターン

### 1. Hard‑Coded Prompt Pattern（ハードコーディングプロンプト）
- **概要**：プロンプトをソースコードに直書きし、環境差分や変更が直接コード改修になる。
- **問題点**：テスト・改修困難、デプロイ頻度増、バージョン不整合。
- **発生例**：小さな文言変更のために全サービス再デプロイ→運用負荷。

### 2. Over‑Engineering Prompts（過剰プロンプト設計）
- **概要**：あらゆるケースを網羅しようとしプロンプトが長大化・複雑化。
- **問題点**：レイテンシ・コスト増、却って精度低下。
- **発生例**：トークン数 16k 超で応答遅延、ハルシネーション増大。

# Error Handling & Resiliency Patterns

## 概要
Error Handling & Resiliencyパターンは、生成AIシステムにおいてAPIエラー、通信失敗、レート制限など各種障害に耐え、リカバリ可能な堅牢な設計を支えるパターン群です。可用性、信頼性、SLA達成率向上を目的とし、現実世界での運用に不可欠な設計戦略を体系化します。

### ユースケース例
- 高可用性を求められるチャットボットサービス
- SLA保証が必要なエンタープライズ向け生成AIプラットフォーム
- レート制限や一時障害を考慮するリアルタイムアプリケーション

---

# 各デザインパターン詳細

## 1. Safe Retry with Prompt Modificationパターン
**説明**: エラー発生時に、単純リトライではなくプロンプトの軽微な変更を加えて再送する。
**用途**: 一時的なエラーや曖昧エラーのリカバリ。
**解決する課題**: 同一リクエストを繰り返すことで失敗し続ける問題。
**対象**: ユーザー応答が必須な対話型アプリケーション。
**メリット**: リトライ成功率向上、エラーの自己修復促進。
**注意点**: 無関係なプロンプト変更は期待する応答品質を損ねる可能性がある。

## 2. Failure Classification & Routingパターン
**説明**: エラーを分類し、エラー種別ごとに適切なリカバリ戦略やリトライポリシーを選択する。
**用途**: 異常に応じた柔軟なリカバリ実施。
**解決する課題**: すべてのエラーを一律に扱い、リカバリ効率が悪化する問題。
**対象**: 高信頼要求の業務システム。
**メリット**: リカバリの成功率向上、過剰リトライ削減。
**注意点**: エラー分類ロジックの正確性がシステム信頼性に直結する。

## 3. Circuit Breaker for Inferenceパターン
**説明**: 一定以上連続失敗した推論経路を一時遮断し、システム全体への波及を防ぐ。
**用途**: 部分障害を局所化し、システム健全性を維持する。
**解決する課題**: 障害がシステム全体に伝播する問題。
**対象**: SLA重視の生成AI API運用基盤。
**メリット**: フェイルファストでサービス全体ダウンを防止。
**注意点**: 回復判定（Half-Open判定）のチューニングが重要。

## 4. Load Shedding Prompt Throttlingパターン
**説明**: システム負荷過多時に低優先度リクエストや無理なリクエストを制御・削減する設計。
**用途**: レート制限、過負荷防止。
**解決する課題**: 過剰リクエストによる全体障害。
**対象**: 大量リクエストを受けるマルチテナント型SaaS。
**メリット**: サービス全体の可用性維持。
**注意点**: 優先度ポリシー設計の誤りに注意（VIPユーザー誤制御など）。

## 5. Self-Healing Pipelineパターン
**説明**: エラー発生時に自動修正を試み、再送・リカバリを組み込んだ推論パイプラインを設計する。
**用途**: 自律的なリカバリによる可用性向上。
**解決する課題**: 人手介入前提の運用コスト増加。
**対象**: 長時間連続稼働が必要なシステム。
**メリット**: 自動回復による運用負荷削減。
**注意点**: 自動回復処理の誤作動による品質低下リスクに注意。

## 6. Idempotent Inference Requestパターン
**説明**: 同一リクエストを複数回送っても結果が一貫する冪等性（idempotency）を担保する設計。
**用途**: ネットワーク再送時の安全確保。
**解決する課題**: リトライによるデータ不整合。
**対象**: トランザクション性の高い生成AIシステム。
**メリット**: リトライ・再送時のデータ整合性保証。
**注意点**: リクエスト識別子管理が必須。

---

# アンチパターン一覧（Error Handling & Resiliency）

| アンチパターン | 問題点 | 発生しうる課題例 |
|:--|:--|:--|
| 無限リトライ | 障害発生時に無制限リトライ | さらに負荷が増大し、サービス全体が停止 |
| リトライ即断念 | 軽微なエラーでも即諦める | 一時エラーで機会損失、成功可能性を逃す |

---

# 総括
Error Handling & Resiliencyパターン群は、現実の運用環境下で生成AIサービスを"止めない・壊さない"ための基盤設計です。適切なエラー検知・分類・リカバリ戦略を実装し、これらアンチパターンを回避することで、堅牢かつ信頼性の高いサービス提供が可能になります。


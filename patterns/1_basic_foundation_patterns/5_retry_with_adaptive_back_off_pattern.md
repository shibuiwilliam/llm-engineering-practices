# Retry with Adaptive Back-off Pattern

## 概要

Retry with Adaptive Back-off Patternは、LLM APIへのリクエストが失敗した際に、一定の間隔を空けて再試行（リトライ）する仕組みを持つ設計パターンです。固定間隔ではなく、失敗回数に応じて待機時間を動的に伸ばす「適応的バックオフ戦略」を採用することで、負荷集中や連続失敗を抑制し、システム全体の安定性を高めます。

## 解決したい課題

Web APIのレスポンスが遅延または失敗することは避けられないことです。そのため、Web APIを利用するシステムでは遅延や失敗を考慮したロジックが求められます。Web APIが遅延、失敗する原因は様々ですが、システムで障害が発生している場合、継続してリクエストを送り続けることは避けたほうが良いでしょう。失敗を回避するためにタイムアウトとリトライを頻繁に実行するようにアプリケーションを作った場合、Web APIの負荷となります。または、Web API側でレート制限を設けている場合、そのアプリケーション（またはユーザ）はレート制限エラーでアクセス不可になることでしょう。LLM APIもWeb APIとして実装されている以上、同様の事態が発生します。

1. **一時的なレート制限エラー（429）**
   - OpenAI APIに対して多くのリクエストを一斉に送った結果、レート制限に引っかかって一部のリクエストが拒否される。

2. **瞬間的なネットワーク障害やタイムアウト**
   - バックエンドとLLMプロバイダ間でネットワークが不安定になり、一時的に接続が失われる。

3. **再試行が集中することでシステムが過負荷に**
   - 失敗直後に全てのクライアントが即座に再試行を行い、さらにAPIが応答不能に陥る。

## 解決策

リクエストが失敗した場合に、単純なリトライではなく、指数関数的に遅延時間を伸ばしながら再試行する「エクスポネンシャルバックオフ」や「ジッター付きバックオフ」を導入します。これにより、一時的な障害に対して効果的に対応しつつ、過剰なリトライによる再負荷を防ぐことができます。

1. 最初のリトライは1秒後、次は2秒後、4秒後、8秒後…というように間隔を増加させます。

![img](./uml/images/retry_with_adaptive_back_off_pattern.png)

## 適応するシーン

このパターンは以下のような場面で特に有効です。

- 高頻度にLLM APIを呼び出すサービス（チャットボット、バッチ処理、RAGパイプラインなど）
- レート制限のある外部APIとの通信が不可欠なアプリケーション
- ネットワーク障害時にサービスを即時停止せずに復旧を図りたいシステム
- SLA遵守が求められる業務アプリケーションで、失敗率を低減させたいケース

## 利用するメリット

このパターンを採用することで、以下のメリットが得られます。

- 一時的な障害に対して自動的に復旧を図ることができます。
- LLM API側への過負荷を抑制できます。
- レート制限やエラー状況に柔軟に対応し、成功率を高めることができます。
- 手動再送やユーザ介入を減らし、ユーザ体験の品質を保てます。

## 注意点とトレードオフ

このパターンを採用する際は、以下の点に注意が必要です。

- リトライによる処理の遅延が発生するため、リアルタイム性が求められるシナリオでは注意が必要です。
- バックオフの設計が不適切だと、リトライが無限に繰り返されたり、障害復旧までに時間がかかることがあります。
- 再試行対象の失敗が「恒久的なエラー（例：認証エラー）」である場合、リトライは意味をなさず、逆に無駄なトラフィックとなります。

## 導入のヒント

このパターンを効果的に導入するためのポイントは以下の通りです。

1. 再試行対象のエラーコードを事前に明確に定義してください（例：HTTP 429, 503）。
2. 最大リトライ回数や最大バックオフ時間を設定し、過剰な待機や処理継続を防止します。
3. バックオフに「ランダムジッター（揺らぎ）」を加えることで、クライアントの一斉リトライを防止できます。
4. ログやメトリクスを通じてリトライ頻度・成功率をモニタリングし、最適な戦略にチューニングしてください。

## まとめ

Retry with Adaptive Back-off Patternは、外部LLM APIとの通信における信頼性と復元力を高めるための基本かつ効果的な戦略です。単純なリトライでは対応しきれないレート制限や一時的な障害に対しても、適応的な再試行によって安定したユーザ体験と高い成功率を両立させることができます。ただし、導入時には適切な失敗判断と待機戦略を設計することが成功の鍵となります。

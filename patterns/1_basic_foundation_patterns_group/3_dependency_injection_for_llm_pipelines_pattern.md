# Dependency Injection for LLM Pipelines Pattern

## 概要  

Dependency Injection for LLM Pipelines パターンは、プロンプトの構築、モデル呼び出し、応答の後処理といった一連の LLM パイプライン処理をモジュール化し、それぞれを疎結合にするための設計手法です。これにより、各処理ステップを柔軟に差し替えたり、テスト容易性を高めたりすることができます。

## 解決したい課題  

LLMを利用したアプリケーションを作る際、LLM周辺の処理（リクエストプロンプトの生成、リクエスト、レスポンスの後処理等）をつなげてパイプラインとして構成することは多々あります（参考：LangChain）。

LLM を活用したパイプラインは、プロンプトの組み立て、モデル推論、レスポンスのパースや加工など複数のステップから構成されます。パイプラインの各ステップで必要となるリソース（永続化データ、外部インタフェース等）や機能（APIリクエスト、推論、正規化等）は異なることが多く、それぞれを実装する必要があります。これらを一つの関数やクラスに密結合で実装することは避けたほうが良いでしょう。もちろん一箇所に実装したほうが最初はわかりやすく作りやすいかもしれませんが、各リソースの再利用や複雑なパイプラインの実現のためには、それぞれを疎結合にしていくことが求められます。密結合に作ることで発生する課題には以下のようなものがあります。

- **テストが困難になる**  
  モデル呼び出しを含む関数は、モックが難しく、単体テストが実施しづらくなります。

- **再利用性が低い**  
  似たような処理でも別のコンポーネントを作らなければならず、同じロジックの重複実装が発生します。

- **変更の影響範囲が大きくなる**  
  プロンプト形式を変更する場合に、全体の構造を見直す必要が生じます。

## 解決策  

各処理ステップ（例：プロンプト構築、モデル呼び出し、応答処理）をインターフェース化し、それらを DI（Dependency Injection）で組み合わせる構成にします。これにより、各ステップを独立して開発・テスト・運用できるようになります。これらの依存をコンストラクタや DI コンテナを通じて注入することで、柔軟な構成変更やテストが可能になります。

- **プロンプトビルダ**
  入力からプロンプト文字列を構築する責務を分離します。

- **モデルクライアント**
  LLM 呼び出しの部分をインターフェースとして切り出します。

- **レスポンスパーサ**
  LLM の応答を目的のデータ構造へ変換する処理を明確に分離します。
  - 参考： **Structured Output Pattern**

![img](./uml/images/dependency_injection_for_llm_pipelines_pattern.png)

## 適応するシーン  

このパターンは以下のような場面で特に有効です。

- プロンプト構築、推論、応答処理の再利用が複数のパイプラインで求められるプロジェクト  
- テスト駆動開発（TDD）やCI/CDを導入しているLLM活用プロダクト  
- 外部ベンダーやOSSモデルの切り替えを前提とした設計が求められるシステム  
- チーム内で複数のエンジニアが別々の処理ステップを分担して実装する場合  

## 利用するメリット  

このパターンを採用することで、以下のメリットが得られます。

- 各コンポーネントの **単体テスト** が容易になります。  
- モデル部分の差し替えや応答処理の変更が **局所的な変更** で済むため、保守性が向上します。  
- ステップ単位の再利用性が高まり、 **DRY（Don't Repeat Yourself）原則** を実現できます。  
- A/B テストや新機能追加時に、 **差分のみの実装** で済みます。  

## 注意点とトレードオフ  

このパターンを採用する際は、以下の点に注意が必要です。

- 小規模プロジェクトでは構造が複雑に見える可能性があり、初期設計の学習コストがやや高くなります。  
- インターフェースの粒度を細かくしすぎると、過度な抽象化により開発スピードが低下する恐れがあります。  
- DI を利用するためのフレームワークや設定管理が必要となる場合があります。

## 導入のヒント  

このパターンを効果的に導入するためのポイントは以下の通りです。

- 初期段階では `PromptBuilder`、`LLMClient`、`ResponseParser` の3つの基本ステップをインターフェース化することから始めてください。  
- DI ライブラリ（例：Python の `dependency-injector` や `FastAPI` の DI 機構）を活用すると実装が容易になります。  
- ステップごとにログやメトリクスを埋め込むことで、運用時の可観測性を高められます。

## まとめ  

Dependency Injection for LLM Pipelines パターンは、LLM を活用したシステムにおける柔軟性・テスト性・保守性を大幅に高める設計手法です。特に、将来的に処理ステップの変更や差し替えが頻発するようなプロダクトにおいては、早い段階での導入が大きな効果をもたらします。構造の整理と抽象化により、安定した継続開発・運用を実現することができます。

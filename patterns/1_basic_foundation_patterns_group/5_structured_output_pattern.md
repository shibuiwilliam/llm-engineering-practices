# Structured Output Pattern

## 概要

Structured Output Patternは、LLM（大規模言語モデル）からの出力を事前に定義した構造（JSON, dataclass, pydantic.BaseModel等）で受け取るための設計手法です。このパターンにより、システムは生成結果を安全かつ機械的に処理できるようになります。OpenAIのfunction calling / tool callingやJSON schema等を活用することで、モデルの出力を自動で検証・構造化することが可能です。

## 解決したい課題

ほとんどのプログラミング言語は文字列型の自然言語を扱うよりも、構造化されたオブジェクトを扱うほうが得意でしょう。他方でLLMは自然言語処理をベースとしており、入出力の基本も自然言語です。プログラムからLLMにリクエストしてレスポンスを受け取るとき、自然言語（文字列型）だけで操作する難点は、プログラムが必要な情報を文字列の中からパースして検索する必要があることです。自然言語は自由に記述できるため、パースや検索のルールに漏れがある可能性は否めません。こうした状態では以下のような問題があります。

- **パースエラーの頻発**
   期待されるJSON形式で出力されるはずが、文法的に不正な文字列が含まれ、エラーになります。

- **安全性の低さ**
   出力に予期せぬ内容が含まれており、誤ったビジネスロジックが実行されるリスクがあります。

- **デバッグや検証の困難さ**
   自由形式の自然文では、どのフィールドがどのように解釈されるか分かりづらく、テストが複雑になります。

## 解決策

昨今のLLM APIの多くはStructured Outputをサポートしています。OpenAI APIであればfunction calling / tool callingやJSON schema等によって、プログラムが指定した構造でレスポンスすることを指示することができます。Structured Output Patternでは、LLMに対して事前に定義した構造に従って出力するよう明示的に指示し、その構造にマッチする形式でレスポンスを受け取ります。

- **出力スキーマの定義**
   JSONスキーマをプロンプトに明記して、`{ "title": ..., "summary": ... }` という形式の出力を促すように設計します。

- **型安全な変換**
   LLMからの応答を構造にマッピングし、型安全に扱える形式（オブジェクト、辞書、構造体など）に変換します。

- **構造に従わないハルシネーションの検知**
   LLMからの応答が指示した構造に従わない場合、Validationすることでハルシネーションを検知します。

![img](./uml/images/structured_output_pattern.png)

## 適応するシーン

このパターンは以下のような場面で特に有効です。

- データ抽出タスク（エンティティ抽出、数値情報の取得など）
- APIレスポンスを介して下流システムへデータを渡す必要がある場合
- JSONやCSVなど定型出力が求められるユースケース
- ユーザ入力を構造化し、内部処理に利用したい場合

## 利用するメリット

このパターンを採用することで、以下のメリットが得られます。

- 出力形式が定型化され、パースや型変換が容易になります。
- 異常値や欠損値の検出がしやすくなり、信頼性が向上します。
- システム間連携（API呼び出しなど）が容易になります。
- 入出力スキーマの検証により、ユニットテストや自動化がしやすくなります。

## 注意点とトレードオフ

このパターンを採用する際は、以下の点に注意が必要です。

- LLMが構造化出力に完全に従わない場合があり、例外処理が必要になります。
- スキーマに制約をかけすぎると、柔軟性が損なわれる場合があります。
- トークン数が増えるため、プロンプトサイズやコストに注意が必要です。
- モデルのバージョンによって出力整形の正確性が変わることがあります。

## 導入のヒント

このパターンを効果的に導入するためのポイントは以下の通りです。

1. 出力スキーマをdataclassやpydantic.BaseModelで明示的に定義します。
2. JSON schemaやFunction Calling / Tool Calling対応モデルを優先的に活用します。
3. Pydantic等のライブラリで型バリデーションを実装します。

## まとめ

Structured Output Patternは、LLMの生成出力を構造化して扱うための実用的なアプローチです。これにより、信頼性の高いシステム連携や自動処理が可能になり、業務への適用範囲が大きく広がります。一方で、出力の正確性に依存するため、堅牢なスキーマ設計と例外処理が重要です。

# Self‑Verification Pattern

## 説明  
Self‑Verification Pattern は、LLM が自身の出力結果を“検証”するための追加プロンプト／サブワークフローを同一セッション内で起動し、**出力の正当性や一貫性**をモデル自身にチェックさせる手法です。  
- **二段階生成**：メイン生成→検証用プロンプトで「正しいか？」「論理整合性は？」などを評価  
- **検証ロジック**：事前定義したチェック項目（フォーマット、数値整合、事実照合など）をモデルに提示  
- **スコアリング／フィードバック**：検証結果に応じて再生成、フォールバック、あるいは人手宛アラートを発行  
- **自動修正ループ**：自己回答の誤り箇所を特定し、修正指示プロンプトに渡して再生成  

## 用途  
- **データ抽出 API**：住所や日付、金額といった重要フィールドを抽出後に、妥当性チェック（形式・範囲）  
- **自動要約ツール**：要約結果が元文の主要トピックを欠落していないか自己評価  
- **コード生成アシスタント**：生成コードのコンパイル可能性やパターン準拠を自己テスト  
- **FAQ 自動応答**：自動回答が質問意図に沿っているか論点カバレッジを検証  

## 解決する課題  
1. **誤出力検出不足**  
   - 生成品質テストを人手に頼るとコスト高・漏れ多発  
2. **一貫性欠如**  
   - 回答間で矛盾や抜けがあり、UX や信頼性が低下  
3. **ドリフト・劣化見逃し**  
   - プロンプト変更後の出力品質低下を自動検出できない  
4. **運用コスト増大**  
   - 人力レビュー中心ではスケールせず、リリースサイクルが遅延  

## 対象とするシステム／プロジェクト  
- **エンタープライズチャットボット**：重要問い合わせで自己検証付き応答を返し、誤回答を未然防止  
- **金融レポート生成**：数値計算・比較ロジックを含むレポートで、自己チェック後に出力  
- **ドキュメント QA**：ドキュメント内検索回答を行った後、根拠テキストとの整合性を自己検証  
- **自動コードレビュー**：生成したコードに対し単体テスト例を生成し、自己検証で品質担保  

## 利用するメリット  
- **品質向上**：モデル自身が誤りを検知・修正することで精度・信頼性が飛躍的に向上  
- **コスト効率**：人手レビューを大幅に削減し、自動化テストを CI/CD に組み込み可能  
- **継続的監視**：リリース後も自己検証ログをモニタしてドリフトを早期に検知  
- **UX 改善**：誤回答率が低下し、ユーザの信頼・満足度が向上  

## 注意点とトレードオフ  
- **追加レイテンシ**  
  - 検証プロンプト呼び出しに伴う二重推論で応答時間が増加  
- **コスト増**  
  - 二度の API コール分のトークン使用量・リクエスト料金がかかる  
- **検証品質依存**  
  - 検証プロンプト設計が不十分だと誤検出や過剰自己否定のリスク  
- **ループ発散リスク**  
  - 修正→検証のループでモデルが安定解に辿り着かないケース  

## 導入のヒント  
1. **重点検証項目選定**  
   - すべてではなく「クリティカルフィールド」「主要論点」など重点領域に絞り込む  
2. **しきい値設定**  
   - 自己検証のスコア閾値を設定し、再生成／人手レビュー切替ポイントを明確化  
3. **段階的オンボード**  
   - 最初はテスト環境でログのみ取得し、本番では再生成→人手介入から導入  
4. **プロンプトテンプレート管理**  
   - 検証用プロンプトと修正指示プロンプトをテンプレート化し、バージョン管理  
5. **モニタリング＆アラート**  
   - 検証失敗率や再生成回数をダッシュボード化し、異常スパイクを即時通知  

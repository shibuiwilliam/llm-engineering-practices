# Canary Release & Rollback Pattern

## 説明  
Canary Release & Rollback Pattern は、新しいプロンプトやモデル変更を最初に「カナリアユーザ群（ごく一部のトラフィック）」にのみ段階的に適用し、問題がなければ徐々に本番全体へ展開、万一品質劣化が確認された場合は即座に旧バージョンにロールバックして影響範囲を最小化する運用手法です。  
- **カナリア配信**：トラフィックの一部（例：1–5%）を新プロンプトにルーティング  
- **フェイルファスト監視**：エラー率、レイテンシ、UX 指標をリアルタイム集計  
- **自動ロールバック**：監視閾値を超えたら自動的に旧プロンプトへ切り戻し  
- **段階的拡大**：安定性確認後に 10%、25%、50%、100% と順次切替  

## 用途  
- **重大プロンプト変更**：システム命令文や対話戦略の大規模更新時に安全展開  
- **新モデル導入**：異なる LLM バージョンやプロバイダ切替の品質検証  
- **UX 実験**：新対話フローやテンプレートを少数ユーザで先行テスト  
- **コンプライアンス対応**：特定リージョンや顧客グループにのみ新機能を順次開放  

## 解決する課題  
1. **全量リリースリスク**  
   - 一括展開で品質低下やバグが全ユーザに波及  
2. **ダウンタイム回避**  
   - 本番停止なしに新旧バージョン間の切替を安全に実施  
3. **品質観察不足**  
   - 実運用トラフィックに対する本番検証が不足し、ステージングとのギャップが発生  
4. **緊急ロールバック困難**  
   - 問題発生時に旧バージョンへ戻せず、影響範囲が拡大  

## 対象とするシステム／プロジェクト  
- **グローバルチャットボット**：地域別ユーザをカナリアグループに割り当て、新対話ロジックを検証  
- **エンタープライズ FAQ システム**：重要顧客のみ先行切替し、応答品質を確認  
- **RAG 要約バッチ基盤**：新要約テンプレートで一部ドキュメントを試験生成  
- **カスタマーサポート AI**：新トーンやスタイルを限定ユーザに適用し、満足度を比較  

## 利用するメリット  
- **影響範囲最小化**：問題発生時の対象ユーザを絞り込み、全体被害を防止  
- **継続可用性**：サービス停止なしにバージョン切替・ロールバックが可能  
- **実運用検証**：ステージングでは捉えきれない実際のユーザ挙動を早期に把握  
- **データ駆動リリース**：UX 指標やエラー統計に基づく意思決定で安全かつ迅速な展開  

## 注意点とトレードオフ  
- **運用の複雑化**  
  - トラフィック分割、監視設定、自動ロールバックロジックの実装と管理工数が増加  
- **リソース重複**  
  - 新旧バージョンを並行稼働させるため、プロビジョニングと依存管理が二重に発生  
- **モニタリング精度**  
  - カナリアグループ規模が小さいと統計ノイズが大きく、誤検知や過剰反応のリスク  
- **切替タイミング調整**  
  - 適切な段階的シフトタイミングを設定しないと、品質確認が不十分なまま拡大する可能性  

## 導入のヒント  
1. **カナリア割合設計**  
   - 初期は 1–2% の小規模から開始し、品質指標が安定してから増加  
2. **明確な監視閾値**  
   - エラー率、平均レイテンシ、ユーザ満足度など各指標に対する KQI/KPI を定義  
3. **フェイルセーフテスト**  
   - ドライラン環境でカナリアシフト／ロールバック動作を事前検証  
4. **ログ＆ダッシュボード**  
   - カナリアグループと全体の比較チャート、ロールバックトリガー履歴を可視化  
5. **段階的自動化**  
   - 最初は手動トリガー、安定後に自動ルール化してオペレーション負荷を軽減  

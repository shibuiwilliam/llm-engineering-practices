# Confidential Prompt Proxy Pattern

## 説明  
Confidential Prompt Proxy Pattern は、ユーザの機密情報（PII、機密ビジネスデータ、法規制対象データなど）を直接 LLM API に送信せず、プロキシ層で安全にマスキング・トークン化・暗号化した上でリクエストを中継し、レスポンス受領後に逆変換して完全な結果を取り戻す設計手法です。  
- **プロキシ層**：アプリケーションと LLM API の間にデータ保護専用サービスを配置  
- **マスキング・トークン化**：機密フィールドを一意トークンに置換し、復元用マッピングを安全ストアに保持  
- **暗号化**：必要に応じてリクエスト全体を対称・非対称暗号化し、プロキシで復号後に API 呼び出し  
- **逆変換フック**：LLM の出力に含まれるトークンを元データに戻し、機密情報付き最終結果を生成  

## 用途  
- **医療診断アシスタント**：患者氏名・ID・診断履歴をトークン化し、生成テキストに匿名化表記を挿入  
- **金融レポート自動化**：口座番号・取引額など機密データをプレースホルダー化して要約し、後で復元  
- **法務ドキュメント分析**：契約書の機密条項を暗号化して LLM に送信し、解析結果のみを取得  
- **社内チャットボット**：従業員の個人評価・給与情報をプロキシで隠蔽し、適切な回答生成を担保  

## 解決する課題  
1. **データ漏洩リスク**  
   - アプリケーションから直接 LLM まで機密情報が平文で渡ると、ログやモデルキャッシュに残留する恐れ  
2. **コンプライアンス要件**  
   - GDPR、HIPAA、PCI-DSS など機密データ取扱規制を満たすために、送信前のデータ保護が必須  
3. **サードパーティ監査制約**  
   - LLM プロバイダに機密データを渡せない場合、プロキシで匿名化・マスキングが必要  
4. **ログ／モニタリング**  
   - 通常ログには機密値を残さず、プロキシログでアクセス履歴を安全に記録・監査  

## 対象とするシステム／プロジェクト  
- **医療情報システム**：患者情報を安全に要約・翻訳するヘルスケアアプリ  
- **銀行業務自動化**：取引明細・顧客プロファイルを取り扱うレポート生成パイプライン  
- **法務文書レビューツール**：秘密保持契約下のドキュメントを LLM 分析に供するサービス  
- **エンタープライズチャット**：社内機密ナレッジを扱う AI チャットボット基盤  

## 利用するメリット  
- **機密性保証**：機密データはプロキシのみが復号可能、LLM やログに平文が残らない  
- **コンプライアンス準拠**：データ保護ルールを一元化し、規制監査レポート作成が容易  
- **最小露出**：必要な情報のみを限定的に LLM に提示し、不要データは送信しない  
- **一貫した保護**：マスキング／暗号化／ログ管理をプロキシ層で統一運用  

## 注意点とトレードオフ  
- **パフォーマンスオーバーヘッド**  
  - トークン化・暗号化・復号処理によるレイテンシ増大  
- **運用複雑度**  
  - マッピング管理、キー管理、復号フックテストなど、プロキシの運用工数が発生  
- **可用性依存**  
  - プロキシサービス障害時に全 LLM 呼び出しが停止するリスク  
- **スキーマ管理**  
  - 入力／出力フォーマットの変更時にトークン化ルールとマッピングの更新が必要  

## 導入のヒント  
1. **プロキシ冗長構成**  
   - 高可用性を確保するため、プロキシを複数インスタンスでクラスタ化  
2. **段階的マスキング**  
   - まずは最重要フィールドのみトークン化し、徐々に対象範囲を拡大  
3. **キーローテーション計画**  
   - 暗号化キーの定期ローテーションと影響範囲テストを自動化  
4. **モニタリング統合**  
   - プロキシの処理時間・エラー率・マッピングヒット率を可視化して健全性を監視  
5. **テストデータセット整備**  
   - トークン化→復号の一連フローをカバレッジするテストケースを CI に組み込む  

# External Service Pattern

## 説明  
External Service Pattern は、LLM の得意領域外（高度な数値計算、統計分析、機械学習モデル実行、最新情報取得など）の処理を、適切な外部サービスに委譲することで全体の品質と効率を担保する設計手法です。  
- **サービスファサード**：LLM 呼び出し層からは「外部サービスを呼ぶ関数」を透過的に利用  
- **ツールチェーン連携**：計算エンジン（NumPy/Octave/外部 API）、検索エンジン、DB、ML 推論サーバなどを組み込む  
- **プロンプト拡張**：外部サービス結果を受け取り、LLM プロンプトに埋め込むか、LLM の後処理に活用  

## 用途  
- **数理最適化アシスタント**：LLM が提案したプランのコスト・制約検算を数理ソルバーに委譲  
- **データ分析ダッシュボード**：LLM に自然言語で分析要件を指示し、集計・グラフ生成は BI サービスに任せる  
- **最新ニュース要約**：LLM には要約のみを依頼し、最新記事取得はニュース API 経由で実施  
- **画像認識連携**：LLM でキャプション生成、画像分析はコンピュータビジョンサービスに委譲  

## 解決する課題  
1. **LLM の不得意領域依存**  
   - 数学演算や複雑集計など、LLM 単独では誤差やポカミスが発生  
2. **最新情報不足**  
   - 知識カットオフ後のデータ・リアルタイム情報がプロンプトだけでは扱えない  
3. **処理効率の低下**  
   - 大量データの集計・計算をテキストループで行うと時間とコストが膨張  
4. **専門ツール活用不足**  
   - 既存の最適化エンジンや分析プラットフォームの利点を活かせない  

## 対象とするシステム／プロジェクト  
- **財務モデリングプラットフォーム**：キャッシュフロー計算やシナリオ分析を最適化エンジンで実行  
- **マーケティング分析ツール**：LLM でインサイト生成、集計・可視化はBIツールに委任  
- **技術サポートチャットボット**：ログ解析や診断は専用診断サービスで行い、結果を自然言語で提示  
- **ハイブリッドエージェント**：LLM＋外部ツールでタスクフローを包括的に処理  

## 利用するメリット  
- **専門性担保**：専用ツールを使うことで高精度・高信頼の結果を得られる  
- **コスト最適化**：高価な LLM コールを最小化し、軽量なサービス呼び出しで処理分担  
- **スループット向上**：並列化・スケール可能なサービスを組み合わせ、全体性能を改善  
- **最新データ活用**：リアルタイム API 経由で最新情報を即座に反映  

## 注意点とトレードオフ  
- **システム複雑度増**  
  - 複数サービス連携による依存管理と障害対応コストが発生  
- **セキュリティ／認可**  
  - 外部サービス呼び出しには認証情報管理やアクセス制御が必須  
- **一貫性／整合性**  
  - LLM 結果と外部サービス結果の不整合時のフォールバック設計が必要  
- **運用負荷**  
  - サービス API 変更やバージョン管理に合わせた定期メンテナンス  

## 導入のヒント  
1. **抽象インターフェース定義**  
   - `IMathService`, `INewsService` など用途別インターフェースで依存を疎結合化  
2. **フォールバック設計**  
   - 外部サービス障害時には簡易アルゴリズムやキャッシュ結果を返す  
3. **非同期実行**  
   - バッチやウェブフックで非同期呼び出し・結果受け取りを組み込み、遅延を吸収  
4. **テストカバレッジ**  
   - モックサーバ／スタブを用意し、LLM とサービス連携のエンドツーエンドテストを自動化  
5. **メトリクス監視**  
   - 外部呼び出しレイテンシ・エラー率を Prometheus/Grafana などに統合し、アラート設定  

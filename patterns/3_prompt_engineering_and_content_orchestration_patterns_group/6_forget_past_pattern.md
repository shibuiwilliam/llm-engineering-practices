# Forget Past Pattern

## 説明  
Forget Past Pattern は、対話やプロンプトの履歴が誤った方向に進んだり、不要なコンテキストが蓄積して品質を低下させたりした場合に、「特定のチェックポイントまで履歴をロールバック」して再度プロンプトを組み直す手法です。  
- **チェックポイント管理**：会話の重要ステップごとに状態をスナップショット化  
- **ロールバック機構**：誤った分岐が発生した時点まで履歴を戻し、再度適切なプロンプトを適用  
- **動的リセット**：ユーザ操作や自動判定（スコア閾値超過）で過去履歴を忘却し、新規コンテキストへ移行

## 用途  
- **対話型チャットボット**：話題が逸れたときにユーザの指示で「前の話題に戻る」  
- **自律エージェント**：複数ステップのタスク実行中に誤った判断があった場合、その前のステップからリトライ  
- **クリエイティブライティング支援**：プロット生成が期待と異なる方向に進んだとき、プロンプトを再構築  
- **RAG＋LLM パイプライン**：検索結果が不適切だった場合、参照ポイントまで戻して再検索・再生成

## 解決する課題  
1. **コンテキスト汚染**  
   - 誤った発話や期待外の情報が蓄積し、以降の生成品質を低下させる  
2. **トークンコスト増大**  
   - 不要な履歴が長く保持されることでトークン使用量が増え、コストが無駄に膨張  
3. **リカバリ困難**  
   - 一度逸れた会話やプロンプトを手動で修正・再構築するのは手間が大きい  
4. **テスト困難**  
   - 自動化テストで異常系の再現が難しく、失敗ケースを簡単にリトライできない

## 対象とするシステム／プロジェクト  
- **カスタマーサポートチャットボット**：長時間対話で話題が混線した場合の話題復帰機能  
- **対話エージェント／Auto-Agent**：複数ツール呼び出しタスク中に失敗があった際の再試行  
- **インタラクティブ教育プラットフォーム**：誤った解答導出ステップを巻き戻して再学習  
- **ナレッジベースQAシステム**：誤った検索コンテキストをリセットし、再検索～要約パイプラインを再実行

## 利用するメリット  
- **品質回復の自動化**：逸脱した履歴を自動的に取り除いて、安定した生成品質を維持  
- **コスト最適化**：不要履歴を忘却することで、プロンプト長を抑制してトークン使用量を削減  
- **ユーザ制御の柔軟性**：ユーザ／システム判断で任意のタイミングに履歴リセットを許容  
- **運用効率向上**：失敗した会話・タスクの再現性が高まり、エラー対応が容易に

## 注意点とトレードオフ  
- **ユーザ体験の断絶**  
  - 突然過去履歴が消えると、ユーザが混乱したり「文脈が切り替わった」と感じる  
- **チェックポイント設計の難易度**  
  - どこまで戻すか（何を忘れるか）の判断基準を適切に定義しないと逆に混乱  
- **状態管理コスト**  
  - スナップショットや履歴ストアの実装／運用負荷が増える  
- **完全回復の保証なし**  
  - ロールバック後も再度同じ誤りを繰り返すリスクを別途対策する必要

## 導入のヒント  
1. **チェックポイント戦略を明確化**  
   - 「システム指示送信直後」「ユーザ応答直前」など、戻しやすいポイントを設計  
2. **UI/UX で明示的に通知**  
   - 「会話をリセットしました」「前のステップに戻ります」など、ユーザに状態変化を可視化  
3. **スコアリングで自動判定**  
   - 生成結果の品質スコアや逸脱率に応じて自動的にロールバックをトリガ  
4. **部分リセット機構**  
   - 過去全履歴ではなく特定キー・セクションだけを忘却するオプションを提供  
5. **テストシナリオ整備**  
   - 正常系／異常系両方のロールバック動作をユニットテスト・E2E テストでカバー  

# System Prompt Control Pattern

## 説明  
System Prompt Control Pattern は、LLM に渡す「system」メッセージ（システム指示文）を動的に管理・切り替えることで、対話の初期条件やモデルの振る舞いを適切に制御する設計手法です。  
- **レイヤード・システムプロンプト**：  
  1. **グローバル指示**（全アプリ共通）  
  2. **コンテキスト指示**（セッションやユーザ属性ごと）  
  3. **機能指示**（要約／翻訳／分類などタスク単位）  
- **プロンプトポリシーエンジン**：各レイヤをマージし、最終的な system メッセージを生成  
- **動的切り替え**：ユーザ権限や利用プラン、A/B テストフラグなどに応じてシステム指示を変更

## 用途  
- **多機能チャットボット**：ユーザの権限／プランに応じて回答範囲やトーンを制限  
- **マルチテナント API**：テナントごとのガイドラインや禁止ルールを system レベルで設置  
- **実験／A/B テスト**：異なるシステムプロンプト設定を並行して評価し、最適振る舞いを選定  
- **コンプライアンス管理**：法規制や社内ポリシーを system プロンプトに組み込み、一元適用

## 解決する課題  
1. **プロンプト管理の分散化**  
   - 各エンドポイントでハードコーディングすると、更新漏れや不整合が発生  
2. **一貫性欠如**  
   - 同一セッション内で system 指示が固定化できず、文脈維持が困難  
3. **権限・ポリシー適用の複雑化**  
   - ユーザ属性やテナント要件ごとに回答制限を実装すると各所に分散しメンテ難  
4. **実験切り替えの不便さ**  
   - A/B テスト時に system プロンプトを切り替えるたびにコードデプロイが必要

## 対象とするシステム／プロジェクト  
- **エンタープライズチャット基盤**：社内規程／機密情報扱いルールを厳格に制御  
- **カスタマーサポート BOT**：サポートプラン別に対応レベルや言葉遣いを分ける  
- **API プラットフォーム**：複数顧客向けにガバナンスポリシーを system レベルで切り替え  
- **実験環境**：system プロンプトバリエーションを容易に増減し、ユーザ反応を評価

## 利用するメリット  
- **一元管理**：system プロンプトを集中管理し、バージョン管理・ロールバックが容易  
- **柔軟なカスタマイズ**：動的ルールエンジンで、ユーザ属性や環境に応じて設定を切替可能  
- **可観測性向上**：system プロンプト履歴をログ化し、モデルの出力挙動をトレース  
- **迅速な実験**：A/B テストフラグだけで system レイヤを切り替え、影響測定を効率化

## 注意点とトレードオフ  
- **抽象化オーバーヘッド**  
  - ポリシーエンジンや多層レイヤのマージに伴う実行コスト・複雑度が増加  
- **ルール衝突リスク**  
  - 複数レイヤの指示が矛盾すると、想定外の出力やエラーを誘発  
- **運用負荷**  
  - system プロンプト定義の増加により、バージョン管理・テストシナリオが増大  
- **過度な制限リスク**  
  - あまりにも厳格な system 指示はモデルの創造性や柔軟性を損なう可能性

## 導入のヒント  
1. **レイヤ構成を明確化**  
   - グローバル／セッション／タスク層の責務をドキュメント化し、運用ルールを合意  
2. **ポリシー定義ファイル化**  
   - YAML/JSON で system プロンプトテンプレートと条件を宣言的に管理  
3. **シミュレーションテスト**  
   - 主要シナリオごとに system レイヤ合成後の最終プロンプトをテストケース化  
4. **モニタリング連携**  
   - system プロンプト ID やバージョンをメタデータとしてログし、出力品質と相関分析  
5. **ガードレール設計**  
   - 最低限の「禁止ワード」「最大トークン長」などベース指示として常時適用  

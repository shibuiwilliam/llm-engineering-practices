# Prompt Inheritance・Command Pattern

## 説明  
Prompt Inheritance・Command Pattern は、共通の「ベースプロンプト」を継承・拡張しつつ、各種操作（要約、翻訳、分類など）を「コマンドオブジェクト」として扱う設計手法です。  
- **Inheritance**：共通要件（トーン、システム指示、ユーザコンテキスト）を BasePrompt クラスにまとめ、サブクラスで用途別に追加・上書き  
- **Command**：各種プロンプト生成・呼び出し処理を `ICommand` インターフェースで抽象化し、実行／再試行／ログ記録を統一  

## 用途  
- **共通指示文の管理**：企業ポリシーや用語集など、基本指示を一箇所に集約  
- **ユースケース別拡張**：要約、翻訳、意見生成、質問応答など個別要件をサブクラスで定義  
- **実行制御の統一**：コマンドとして呼び出しタイミングやエラーハンドリング、メトリクス計測を一元管理  
- **動的切り替え**：ユーザ権限やプランに応じ、実行時に適切な Prompt+Command を選択  

## 解決する課題  
1. **重複プロンプト定義**  
   - テンプレートごとに同じシステム指示やコンテキスト注入コードをコピペしてしまう  
2. **分散した実行ロジック**  
   - 呼び出し／リトライ／ログ処理が各所に散在し、変更時に多箇所修正が必要  
3. **テスト困難**  
   - プロンプト生成ロジックと実行制御が結合し、ユニットテストが書きにくい  
4. **設定変更の拡散**  
   - ベース指示を変えたい場合、すべてのテンプレートを手動で更新しなければならない  

## 対象とするシステム／プロジェクト  
- **企業チャットボット基盤**：ガイドラインやコンプライアンス指示を一元管理し、多機能チャットに適用  
- **マルチモード文章生成サービス**：要約・翻訳・クリエイティブライティングなど複数モードを同一フレームワークで実装  
- **自動化ワークフロー**：RAG→生成→登録などのステップをコマンドチェーンで表現  
- **プラグイン対応 SDK**：新規プロンプト拡張時にベースを継承して開発できるライブラリ  

## 利用するメリット  
- **再利用性向上**：BasePrompt の変更が全サブクラスに即時反映され、仕様変更コストを削減  
- **責務分離**：プロンプト構築と実行制御（送信、リトライ、ロギング）をコマンド層に分離  
- **テスト容易性**：継承階層とコマンドを個別にモック化でき、ユニットテストを高速化  
- **拡張の柔軟性**：新しい生成モードを追加する際、BasePrompt と ICommand 実装だけで完了  

## 注意点とトレードオフ  
- **継承階層の肥大化**  
  - サブクラスが増えすぎると管理が複雑になり、リファクタリングコストが増大  
- **オーバーヘッド**  
  - コマンドインターフェースと階層化に伴う抽象化レイヤーで若干の実行遅延  
- **複雑度増加**  
  - プロンプト設計者と開発者がパターンを理解していないと、逆に混乱を招く可能性  
- **設定一元化のリスク**  
  - BasePrompt 変更時の影響範囲が広く、リリース前にサブクラス全体の検証が必要  

## 導入のヒント  
1. **BasePrompt を最小設計**  
   - 必須のシステム指示と共通変数注入のみ持たせ、拡張性を確保  
2. **Command インターフェース定義**  
   - `execute(): Promise<Response>`／`undo()`／`retry()` など標準メソッドを合意  
3. **DI と組み合わせ**  
   - DI コンテナで BasePrompt と ICommand 実装をバインドし、実行時に切り替え  
4. **テストカバレッジ確保**  
   - BasePrompt＋サブクラスの単体テストと、コマンドの統合テストを CI に組み込む  
5. **ドキュメント化**  
   - 継承関係図とコマンドフローを README や Wiki に明記し、開発者間で共有  

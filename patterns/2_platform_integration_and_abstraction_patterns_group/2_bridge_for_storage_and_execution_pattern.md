# Bridge for Storage & Execution Pattern

## 説明  
Bridge for Storage & Execution Pattern は、**データ永続化層（Storage）**と**LLM 呼び出し層（Execution）**を明確に分離し、それらをつなぐ「橋（Bridge）」インターフェースを定義する設計手法です。  
- **Abstraction（橋）**：`ILLMService` などの高レベルインターフェースを提供  
- **Implementation A（Storage）**：キャッシュやデータベースからの取得・保存ロジック（例：Redis, DynamoDB, PostgreSQL）  
- **Implementation B（Execution）**：LLM プロバイダへの直接呼び出しロジック  
- **連携フロー**：まず Storage 実装にキャッシュを問い合わせ、ヒットすれば返却、ミスなら Execution 実装で生成 → Storage に保存 → 呼び出し元へ返却  

## 用途  
- **埋め込みキャッシュ**：テキスト埋め込みを初回のみ計算し、2 回目以降は高速キャッシュから取得  
- **会話履歴管理**：過去の対話コンテキストを永続層に保持し、LLM 呼び出し時に自動的にマージ  
- **RAG（Retrieval-Augmented Generation）**：ドキュメント索引データのキャッシュとリアルタイム検索／要約の分離  
- **コスト最適化パイプライン**：高頻度リクエストをキャッシュで吸収し、API コストを削減  

## 解決する課題  
1. **Storage と Execution の結合**  
   - 単一モジュールにキャッシュ・DB ロジックと LLM 呼び出しロジックが混在し、可読性・保守性が低下  
2. **スワップ困難**  
   - キャッシュ基盤を変更するたびに LLM 呼び出しコードも修正が必要  
3. **テスト困難**  
   - キャッシュ・永続層と実際のモデル呼び出しを個別にモック／スタブできない  
4. **パフォーマンス最適化不足**  
   - キャッシュヒット・ミス判定のロジックを粒度よく最適化できない  

## 対象とするシステム／プロジェクト  
- **RAG サービス**：ユーザクエリに対するドキュメント検索＋要約を行う  
- **チャットボット基盤**：長期・短期メモリを併用した対話エージェント  
- **データ強化パイプライン**：大量テキストを対象に埋め込み集計→下流モデルで処理  
- **リアルタイム分析システム**：逐次生成データをキャッシュ → ダッシュボードに反映  

## 利用するメリット  
- **疎結合**：Storage／Execution を個別開発・テストでき、責務分離が明確  
- **拡張性**：キャッシュ基盤や LLM プロバイダを後から差し替えやすい  
- **パフォーマンス最適化**：キャッシュヒット率向上で API コール数・レイテンシを削減  
- **テスト容易性**：Storage 実装と Execution 実装を独立してモックテスト可能  

## 注意点とトレードオフ  
- **実装の複雑化**  
  - Bridge インターフェースと２つの実装を管理する分、コード量と理解コストが増加  
- **オーバーヘッド**  
  - キャッシュチェックの処理分だけ呼び出しレイテンシがやや増加  
- **キャッシュの整合性**  
  - TTL、無効化ポリシー設計を誤ると古いデータを返してしまうリスク  
- **運用コスト**  
  - Storage 基盤の運用・監視（スケーリング、スループット管理）が必要  

## 導入のヒント  
1. **最小構成から開始**  
   - インメモリキャッシュ＋シンプル LLM クライアントの Bridge をまず実装  
2. **DI／Factory と組み合わせ**  
   - 環境（開発・ステージング・本番）ごとに Storage／Execution 実装を切り替え  
3. **メトリクス収集**  
   - キャッシュヒット率、ストレージレイテンシ、API コール数を Prometheus/Grafana へ送信  
4. **キャッシュポリシー設計**  
   - TTL、LRU／LFU ポリシー、手動無効化 API を用意し、古いデータの滞留を防止  
5. **段階的拡張**  
   - 初期は「キャッシュのみ」「Execution のみ」→ 次に両者 Bridge → 最終的に優先度や条件分岐を追加  

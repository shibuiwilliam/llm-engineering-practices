# Prompt Unit Testing Pattern

## 説明
Prompt Unit Testing Pattern は、LLM を呼び出す前後の「期待入出力」をあらかじめ定義し、その結果を自動的に検証するユニットテスト手法です。  
- **入力プロンプト** と **期待される出力**（キーワードの包含、スキーマ準拠、抽出値など）をテストケースとして管理  
- モデル呼び出しをモック（フェイク）し、テスト時には固定のスタブレスポンスで検証  
- 実際の呼び出しを行うインテグレーションテストと組み合わせることで、品質保証レベルを階層化  

## 用途
- **プロンプト開発初期段階**：文言やテンプレートを修正した際にリグレッションを防ぐ  
- **CI/CD パイプライン**：プルリクエスト単位でプロンプト品質チェックを自動化  
- **マルチモデル比較**：異なるモデルバージョン／プロバイダで出力差を検出  
- **リファクタリング**：テンプレート構造変更後に既存動作との整合性を保証  

## 解決する課題
1. **プロンプト修正時のバグ発生**  
   - 文言微調整で生成結果が意図しない方向にズレるリスク  
2. **品質保証の不透明性**  
   - 自動化テストを持たないと手動 QA に依存し、見落としや属人化が進行  
3. **モデル切り替えコスト**  
   - 新しいモデルを導入した際、既存プロンプトが同様に機能するか検証困難  
4. **テンプレート進化の管理**  
   - テンプレートのバージョンアップ時に既存ユースケースが破壊される問題  

## 対象とするシステム／プロジェクト
- **エンタープライズ向けチャットボット**：FAQ テンプレートやガイドライン文言を厳格に保守  
- **ドキュメント要約サービス**：品質水準を SLA で保証し、要件変化に応じて適用  
- **対話型教育プラットフォーム**：質問応答プロンプトの正答率を継続的に監視  
- **RAG＋LLM パイプライン**：検索クエリ組立プロンプトや抽出プロンプトの回帰テスト  

## 利用するメリット
- **早期バグ検出**：プロンプト変更で生じる誤動作を即座に検知  
- **自動化による信頼性向上**：CI 連携で人手によるチェックコストを削減  
- **リグレッション防止**：プロンプト進化時の既存ユースケース破壊を回避  
- **ドキュメント化**：テストケース自体がプロンプト仕様書として機能  

## 注意点とトレードオフ
- **モックと実際の乖離**  
  - 実際のモデル応答はモックと異なるため、インテグレーションテストも必須  
- **テストメンテナンスコスト**  
  - モデルアップデートや要件変更時に期待出力の見直しが増加  
- **ハードコーディングリスク**  
  - 出力完全一致テストは柔軟性を損ないがち。部分一致や正規表現による検証が望ましい  
- **テスト実行時間**  
  - 大量のユニットテストを含むと CI パイプラインが遅延。テストケースの優先度付けが必要  

## 導入のヒント
1. **プロンプト定義とテスト同期**  
   - テンプレートファイルとテストケースを同一リポジトリ内でペア管理  
2. **部分検証から開始**  
   - 完全一致ではなく「必須キーワードを含む」「JSON スキーマ準拠」など柔軟なアサーションを先に設定  
3. **モックレスポンス設計**  
   - スタブデータは代表的な正常系／異常系パターンを複数用意し、モック層で切り替え  
4. **CI／CD 連携**  
   - PR 作成時に自動テストを実行し、失敗ケースはマージ禁止ルールを適用  
5. **定期レビュー**  
   - モデルバージョンアップや仕様変更のタイミングでテストケースの見直しを定期化  

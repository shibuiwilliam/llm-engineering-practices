# Structured Prompt Template Pattern

## 説明
Structured Prompt Template Pattern は、プロンプト内容をコード中の文字列連結で直書きせず、YAML/JSON やテンプレート言語（Mustache、Jinja2 など）で「構造化」して定義・管理する手法です。  
- **テンプレートファイル**：変数やループ、条件分岐を含めた雛形を外部ファイル化  
- **パラメータ注入**：実行時にパラメータマップを渡してテンプレートをレンダリング  
- **型安全／検証**：必要に応じて JSON Schema や Pydantic でテンプレート変数のバリデーション

## 用途
- **多言語対応チャットボット**：言語ごと・シナリオごとにテンプレートを切り替え  
- **要約・翻訳パイプライン**：モデル呼び出し前のプロンプト組み立てを自動化  
- **ダイナミックなドキュメント生成**：ユーザ情報や外部データを埋め込んでテンプレートを生成  
- **A/B テスト**：プロンプト文言をテンプレート変数で切り替えて効果測定  

## 解決する課題
1. **ハードコーディングによるバグ**  
   - 文字列連結ミス・不要な空白・改行のずれなど  
2. **可読性・保守性の低下**  
   - 長大なプロンプトをコード内に埋め込むと diff が読めず改修困難  
3. **再利用性の欠如**  
   - 同様の文言を複数箇所にコピペ管理し、一箇所修正ミスのリスク  
4. **動的構造の実装困難**  
   - 条件分岐や繰り返しで変化するプロンプトを手動で組むとミス多発  

## 対象とするシステム／プロジェクト
- **エンタープライズ向けチャット基盤**：シナリオやユーザ属性に応じたテンプレート切り替え  
- **バックエンドバッチ処理**：大量ドキュメントに同一フォーマットのプロンプトを一括適用  
- **マルチテナント SaaS**：テナントごとにカスタマイズ可能なプロンプト管理機構  
- **マイクロサービスアーキテクチャ**：各サービスが独自テンプレートを持ちつつ共通ライブラリで処理  

## 利用するメリット
- **保守性向上**  
  - テンプレートとコードを分離し、ドメイン担当者が容易に文言修正  
- **再利用性**  
  - 共通部分をインクルード／マクロ化して複数シナリオに横展開  
- **可視化／ドキュメント化**  
  - テンプレートファイル自体が仕様書代わりになる  
- **テスト自動化**  
  - 変数バリデーションやレンダリング結果のスナップショットテストが可能  

## 注意点とトレードオフ
- **学習コスト**  
  - テンプレート言語の習得が必要  
- **ランタイムオーバーヘッド**  
  - テンプレートエンジンのレンダリング時間が発生  
- **複雑化リスク**  
  - 条件分岐・ループを多用しすぎるとテンプレート自体が読みにくくなる  
- **バージョン管理**  
  - テンプレートとスキーマ（JSON Schema など）を同期管理する必要  

## 導入のヒント
1. **最小限から開始**  
   - まずは変数差し替えだけの簡易テンプレートを外部化  
2. **テンプレートエンジン選定**  
   - プロジェクト言語に合った軽量エンジン（Mustache, Jinja2, ERB など）を採用  
3. **スキーマ検証**  
   - JSON Schema や Pydantic で必須変数・型チェックを組み込む  
4. **テストカバレッジ**  
   - テンプレートレンダリング結果のスナップショットテストを CI に組み込む  
5. **ドキュメント化**  
   - テンプレートファイルに見出しコメントや変数一覧を記載して仕様書化  

# Timeout & Fallback Pattern

## 説明
Timeout & Fallback Pattern は、LLM API や外部サービス呼び出しにおいて「一定時間内に応答が得られない場合に強制キャンセルし、代替手段（キャッシュ、静的応答、別モデルなど）でフォールバックする」仕組みを提供するレジリエンス設計です。  
- **Timeout**：呼び出しライブラリ（HTTP クライアントや SDK）に最大待機時間を設定  
- **Fallback**：タイムアウト発生時やエラー時に実行する代替ロジックを定義  

## 用途
- リアルタイムチャットボット：応答遅延を防ぎ、定型文やキャッシュ回答に即切り替え  
- Web API マイクロサービス：下流の LLM サービス遅延で上流リクエストが詰まらないように制御  
- バッチジョブ／ETL：遅延またはダウンしたモデル呼び出しをスキップし、次処理へ継続  
- モバイル／IoT クライアント：ネットワーク不安定時にオフラインキャッシュを返却  

## 解決する課題
1. **無限待機によるリソース枯渇**  
   - 長時間応答を待ち続け、スレッド／コルーチンが枯渇しサービス全体が停止  
2. **不安定なユーザ体験**  
   - ユーザ画面が何も返さず固まることで操作感が著しく低下  
3. **SLA 違反リスク**  
   - API レイテンシが予測不能 → 下流システムに波及して全体の SLA 達成困難  
4. **障害の顕在化遅延**  
   - タイムアウトなしではサービスダウンを検知しづらく、復旧が後手に  

## 対象とするシステム／プロジェクト
- **オンライントランザクション処理**（チャット、フォーム入力支援）  
- **REST/gRPC マイクロサービス**（LLM 呼び出しを含む API）  
- **リアルタイムダッシュボード**（ユーザが待機時間を許容しない UI）  
- **エッジデバイス連携**（モバイルアプリや IoT）が応答を待てないケース  

## 利用するメリット
- **予測可能なレイテンシ**：最大待機時間を明示することで UI/UX が安定  
- **Graceful Degradation**：モデル停止時も代替手段で最低限の機能を維持  
- **障害早期検知**：タイムアウトで即時例外発生 → アラート・モニタリングが起動しやすい  
- **リソース保護**：過剰な同時要求が溜まらず、システム全体の健全性を確保  

## 注意点とトレードオフ
- **データ新鮮性 vs 安定性**  
  - フォールバックでキャッシュ回答を使うと最新情報でなくなる場合がある  
- **UX 一貫性の課題**  
  - フォールバック回答と通常回答のトーンや品質差がユーザに混乱を与える可能性  
- **過度なタイムアウト設定**  
  - 短すぎると正常処理まで切られる、長すぎると保護効果が薄れる  
- **フォールバックロジックの複雑化**  
  - 複数レイヤで代替戦略を用意すると、制御フローが複雑になりバグの温床に  

## 導入のヒント
1. **段階的タイムアウト**  
   - 「接続タイムアウト」「読み込みタイムアウト」を分けて設定し、最適値を探る  
2. **多段フォールバック設計**  
   - 例： キャッシュ → 軽量モデル → シンプル定型文 の順にフォールバック  
3. **メトリクス計測**  
   - タイムアウト発生率、フォールバック利用率を監視し、閾値超過でチューニング  
4. **トレースログ**  
   - タイムアウト時は詳細な呼び出しコンテキスト（パラメータ、残トークン数）を記録  
5. **ユーザ通知**  
   - UI/UX 上で「応答が遅いため簡易回答に切り替えました」などのガイダンスを表示  

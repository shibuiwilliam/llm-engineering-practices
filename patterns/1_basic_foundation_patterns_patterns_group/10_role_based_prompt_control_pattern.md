# Role-Based Prompt Control Pattern

## 説明  
Role-Based Prompt Control Pattern は、ユーザやシステムの権限レベル（例：管理者／一般ユーザ／匿名）に応じて「どのプロンプト（システム指示文やユーザ指示文）を許可・制限するか」を動的に制御する設計手法です。  
- **プロンプトフィルタ**：受信したプロンプト内容を解析し、ユーザのロールに応じて特定キーワードやコマンドの挿入・削除を行う  
- **ポリシーエンジン**：RBAC（Role-Based Access Control）ルールをコードや設定ファイルで定義し、実行時に適用  
- **システムプロンプトの変換**：ロールに応じてシステムプロンプト（`system` メッセージ）を差し替え、生成結果の範囲を制限

## 用途  
- **企業向けチャットボット**：一般ユーザには FAQ 回答のみ、管理者には内部データ検索や操作コマンドを許可  
- **ドキュメント生成ツール**：承認者ロールは法務テンプレートを使用可能、一般ユーザは要約生成に限定  
- **自動化エージェント**：特定ロールだけが外部 API 呼び出しやデータベース更新プロンプトを含められる  
- **教育プラットフォーム**：講師は解答例を含む詳細プロンプトを実行可能、生徒にはヒント提供に限定

## 解決する課題  
1. **権限外操作の防止**  
   - プロンプト内容に不適切な命令やアクセス許可のないデータ参照が含まれるリスク  
2. **セキュリティ・コンプライアンス**  
   - ユーザ権限と生成内容を紐づけた監査を実現  
3. **運用管理の複雑化**  
   - プロンプトごとにハードコーディングで権限チェックを実装するとメンテナンスが困難  
4. **ユーザエクスペリエンスの一貫性**  
   - 権限不足時に明確なフィードバックやフォールバック動作がないと混乱を招く

## 対象とするシステム／プロジェクト  
- **エンタープライズ向け SaaS**：社内外で権限分離されたチャット／自動化機能を提供  
- **マルチテナントプラットフォーム**：テナント管理者と一般ユーザで機能アクセスを分割  
- **API ゲートウェイ**：ユーザトークンに紐づくロールからプロンプト実行範囲を決定  
- **教育支援システム**：教師・生徒の指示可能なプロンプト範囲を明確に区別

## 利用するメリット  
- **セキュリティ強化**  
  - 権限外プロンプトの実行を強制ブロックし、情報漏洩や誤操作を防止  
- **コンプライアンス対応**  
  - 誰がどの指示を出し、どのような回答を得たか、ロール単位でログを一元管理  
- **メンテナンス容易**  
  - ポリシー定義を設定ファイルや管理UIで一元管理し、コード変更を最小化  
- **柔軟な UX**  
  - 同じアプリでもロールごとに最適化されたインタラクションを提供可能

## 注意点とトレードオフ  
- **ポリシーの複雑化**  
  - ロールや権限が多層化するとルール管理が煩雑になり、誤設定リスクが増大  
- **パフォーマンスオーバーヘッド**  
  - プロンプト解析・ポリシーチェック処理が追加されるため、レイテンシが若干増加  
- **ロール変更の即時反映**  
  - ロールマッピングやキャッシュの刷新が遅れると旧権限が残存する可能性  
- **ユーザフレンドリネス**  
  - 権限不足時のフィードバックを適切に設計しないと「何が制限されているか」分かりにくい

## 導入のヒント  
1. **ポリシー定義からスタート**  
   - YAML/JSON でロール毎に許可テンプレート・禁止ワードリストを先に設計  
2. **段階的適用**  
   - まずはログのみ出力する「モニターモード」→ 次に禁止時は警告 → 最後にブロック  
3. **キャッシュ戦略**  
   - プロンプトチェック結果を短時間キャッシュして頻繁な権限問い合わせを抑制  
4. **UX ガイドライン**  
   - フィードバックメッセージを統一フォーマットで提供し、ユーザが自分の権限を理解しやすく  
5. **テストカバレッジ**  
   - 権限組み合わせテスト（管理者 vs 一般 vs 匿名）を CI に組み込み、抜け漏れを防止  

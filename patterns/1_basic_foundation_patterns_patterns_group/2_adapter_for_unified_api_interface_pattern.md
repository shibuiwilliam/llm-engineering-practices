# Adapter for Unified API Interface Pattern

## 説明  
Adapter for Unified API Interface Pattern は、複数の LLM プロバイダ（例：OpenAI、Anthropic、Cohere、Gemini、オンプレミスの OSS モデルなど）が提供する異なるエンドポイント、リクエスト／レスポンス形式、認証方式を「共通のアプリケーション側インターフェース」に変換するアダプタ層を設ける設計手法です。  
- **Adapter**：各プロバイダ固有の API 呼び出し・認証・レスポンス解析を吸収  
- **Unified Interface**：ビジネスロジック層は `IModelClient.generate(text, params)` など一貫したメソッドのみを呼び出す  

## 用途  
- マルチベンダー対応：運用中にプロバイダを切り替えたり併用したりする SaaS  
- 冗長化／フェイルオーバー：主要 API が不調時に代替プロバイダへ透過的にフォールバック  
- A/B テスト基盤：異なるモデルの性能比較を同一コードパス上で実行  
- SDK／ライブラリ開発：外部開発者向けに背後の API 仕様差分を隠蔽した提供  

## 解決する課題  
1. **API 仕様差分の散在**  
   - 各社の URL、パラメータ名、認証ヘッダ、レスポンス JSON 構造がバラバラ  
2. **ビジネスロジックからの密結合**  
   - 直接 SDK／HTTP 呼び出しを行うと、プロバイダ変更時に多箇所を修正  
3. **テストやモックの困難**  
   - 個別のクライアント実装をモック化せずに一括で置き換えにくい  
4. **エラーハンドリングの重複**  
   - タイムアウト、レート制限、API エラー時の共通対応を各所で実装  

## 対象とするシステム／プロジェクト  
- **クラウドネイティブ SaaS**：世界中の顧客が利用し、モデルコスト最適化が重要  
- **チャット／ヘルプデスク基盤**：可用性を維持するために複数 API を冗長化  
- **AI プラグインプラットフォーム**：サードパーティ製モデルをプラグイン形式で追加可能  
- **研究開発環境**：新モデル評価を迅速に切り替えて実験  

## 利用するメリット  
- **疎結合化**  
  - ビジネスロジックは `IModelClient` のみ依存し、背後の API 変更に影響を受けにくい  
- **拡張性**  
  - 新たなプロバイダ追加は Adapter 実装＋設定追加のみで完結  
- **テスト容易性**  
  - インターフェースをモック化して統一的に単体テスト／統合テスト可能  
- **共通エラーハンドリング**  
  - 再試行、タイムアウト、フォールバックなどを一箇所で管理し一貫性を担保  
- **設定一元管理**  
  - エンドポイントや API キー、タイムアウト閾値をコンフィグファイルに集約  

## 注意点とトレードオフ  
- **オーバーエンジニアリングのリスク**  
  - 単一プロバイダ利用の小規模サービスでは構築コストが回収できない場合も  
- **レイテンシ増加**  
  - Adapter 層を経由する分、呼び出しチェーンが深くなり多少のオーバーヘッド  
- **インターフェース肥大化**  
  - すべてのベンダー固有機能を網羅しようとすると共通インターフェースが複雑化  
- **保守コスト**  
  - 各プロバイダ SDK/API のバージョンアップに伴う Adapter の定期改修が必要  

---

**導入のヒント**  
1. まずは最小限のコアメソッド (`generate`, `embed`) だけを Adapter 化。  
2. DI コンテナやファクトリと組み合わせて、プロバイダ選択を設定ファイルから動的に切り替え。  
3. 共通エラーハンドリング（再試行／フォールバック）とトレースログを Adapter で一括実装し、ビジネスコードをシンプルに保つ。  

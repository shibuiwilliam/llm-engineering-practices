# Token / Window Rate-Limiter Pattern

## 概要
Token / Window Rate-Limiter Patternは、LLM APIや関連サービスに対するリクエスト数を制御するための設計パターンです。一定時間内に許可されるリクエスト数を制限することで、システムの安定性と公平性を確保します。トークンバケットやスライディングウィンドウ方式を用いて、分散システムでも一貫した制御を実現します。

## 解決したい課題
LLMのAPI活用において、以下のような課題が発生します。

1. **レート制限エラー**
   - LLMプロバイダの制限に達してAPIがエラーとなる、あるいはレスポンスが遅延するケースが発生します。
   - 例：OpenAI APIの制限（RPM: Requests Per Minute）に達して、一時的にリクエストが拒否される状況です。

2. **バックエンド過負荷**
   - 一時的なリクエスト集中によって、システムの処理能力を超え、全体の処理が滞る問題が起きます。
   - 例：チャットボットの同時利用者が急増し、システムの応答が著しく低下するケースです。

3. **公平性の欠如**
   - 一部のクライアントやジョブがリソースを独占し、他のユーザの応答性が損なわれる状況が発生します。
   - 例：特定のテナントからの大量リクエストにより、他のテナントの処理が遅延するケースです。

4. **可用性の低下**
   - 突発的なトラフィックによってシステムが不安定になり、SLAを満たせなくなる問題が起きます。
   - 例：バッチ処理の同時実行により、オンライン処理の応答時間が許容範囲を超えるケースです。

## 解決策
Token / Window Rate-Limiter Patternを適用し、以下の方法でリクエストの制御を行います。

1. **トークンバケット方式**
   - 一定の速度でトークンを補充し、トークンを消費してリクエストを許可します。
   - 例：1秒あたり10トークンを補充し、各リクエストで1トークンを消費する実装です。

2. **スライディング／固定ウィンドウ方式**
   - 一定時間ごとにリクエスト数をカウントし、上限に達した場合はリクエストをブロックします。
   - 例：1分間で最大100リクエストまで許可する固定ウィンドウ方式の実装です。

3. **分散対応**
   - Redisやクラウドネイティブなキャッシュを用いて、複数のインスタンス間で一貫した制御を実現します。
   - 例：RedisのINCRコマンドとTTL機能を組み合わせた分散リミッタの実装です。

## 適応するシーン
このパターンは以下のような場面で特に有効です。

- SaaS形式の生成APIを多数のクライアントに提供している場合
- チャットボット基盤に対して、ユーザやワークフローから頻繁に呼び出されるシステム
- 大規模なドキュメント処理などのバッチジョブが並列に実行される場合
- モバイルアプリやIoTデバイスが再接続後に一斉にリクエストを送信するケース

## 利用するメリット
このパターンを導入することで、以下のメリットが得られます。

- システムの安定性が向上し、一定の応答性を維持できます
- プロバイダ側の制限に達する前に自前で制御できるため、レート制限エラーを抑制できます
- ユーザやテナントごとに個別の制限を設けることで、公平なサービス提供が可能です
- 自動的な制限制御により、運用負荷を軽減できます

## 注意点とトレードオフ
このパターンの導入にあたっては以下の点に注意が必要です。

- リクエスト制限により一部処理が待機となり、リアルタイム性が低下する可能性があります
- 分散環境で一貫性を保つために、キャッシュ整合性や競合制御の実装が必要になります
- 閾値やキューの状態を常に可視化しないと、想定外のブロックが発生する可能性があります
- ユーザ行動やトラフィック特性に応じた適切な制限設定が求められます

## 導入のヒント
効果的な導入のために、以下のステップが参考になります。

1. まずは固定ウィンドウでシンプルなリミッタを導入し、実運用での効果を観察します
2. RedisのINCR＋TTL機能を使って、軽量な分散リミッタを構築します
3. PrometheusやGrafanaでヒット率・ブロック数・待機時間を可視化し、パラメータ調整に役立てます
4. リミッタによるブロック発生時に、キャッシュ応答やQueueへの再投入などの代替手段を用意します
5. Consulやetcd、AWS SSMなどを活用して、閾値をリアルタイムに変更可能にします

## まとめ
Token / Window Rate-Limiter Patternは、LLM APIの活用においてリクエストの過集中や公平性の欠如といった課題を解決する重要な設計パターンです。スケーラブルで安定したサービス運用のために、リクエスト制御をシステマティックに取り入れることが推奨されます。導入時にはトラフィック特性に応じた設計と監視の仕組みを整えることが成功の鍵となります。

# Token / Window Rate-Limiter Pattern

## 説明  
Token / Window Rate-Limiter Pattern は、一定時間内に許可するリクエスト数を制御し、LLM API や関連サービスへの過負荷・レート制限超過を防ぐ仕組みです。  
- **トークンバケット**：バケットにトークンを一定レートで補充し、リクエストごとにトークンを消費。バケットにトークンがない場合は処理を待機または拒否。  
- **スライディング／固定ウィンドウ**：一定間隔（例：1 分、1 時間）のカウント枠を設け、枠内の呼び出し回数を上限で制御。枠をまたぐとカウンタがリセットまたはスライドして再計算。  
- **分散対応**：複数インスタンス間で一貫したリミッタを提供するため、Redis やクラウドネイティブの分散キャッシュを併用。  

## 用途  
- **API ゲートウェイ**：外部クライアントからの生成リクエストを適切に制限し、バックエンドモデルの健全性を維持  
- **バッチ処理パイプライン**：大量ドキュメント要約ジョブがスパイク的に走った際、均等にスロットルをかけて安定稼働  
- **マルチテナントサービス**：テナントごとに異なるプラン（無料枠／有料枠）のレート制限を適用  
- **リアルタイムチャット**：ユーザの連打や自動化ツールからの過剰リクエストをガード  

## 解決する課題  
1. **レート制限エラー**  
   - LLM プロバイダのレート制限に達し、API エラーやスローダウンが発生する  
2. **バックエンド過負荷**  
   - 短時間に大量リクエストが集中し、処理レートやリソースが枯渇する  
3. **公平性の欠如**  
   - 一部クライアントやバッチ処理がリソースを占有し、他ユーザへのサービス品質が低下  
4. **可用性低下**  
   - サービス全体のスループットが不安定になり、SLA 達成率が下がる  

## 対象とするシステム／プロジェクト  
- **SaaS 生成 API プラットフォーム**：複数顧客からの同時呼び出しを安定制御  
- **社内チャットボット基盤**：エージェントや自動化ワークフローからの過剰アクセスを防止  
- **大規模バッチジョブ**：一括処理ワーカーが並列で呼び出す際の総量制御  
- **モバイル／IoT クライアント**：ネットワーク断→再接続時のリトライ洪水を緩和  

## 利用するメリット  
- **安定性向上**：バックエンドへの負荷ピークを緩和し、サービス品質を均一化  
- **エラー削減**：プロバイダレート制限エラーを自前で先制的に防ぎ、リトライ制御を容易に  
- **公平なリソース配分**：テナントやユーザごとに異なる制限を設け、SLA を担保  
- **運用負荷軽減**：過負荷時の障害対応を自動化し、インシデント対応コストを削減  

## 注意点とトレードオフ  
- **遅延増加**  
  - 制限に達した際に待機やキューイングを行うため、即時応答性が低下する場合がある  
- **実装複雑度**  
  - 分散環境で一貫性を保つための同期・競合制御が必要で、設計・テスト工数が増大  
- **リソース監視**  
  - バケットやウィンドウの状態を適切にモニタリングしないと、設定ミスで意図せずブロックされる  
- **設定チューニング**  
  - リクエストパターンやトラフィック特性に合わせて閾値や補充レートを最適化する必要がある  

## 導入のヒント  
1. **スモールスタート**  
   - まずは固定ウィンドウで「X リクエスト／分」などシンプル制限を実装し、効果を検証  
2. **分散キャッシュ利用**  
   - Redis や Memcached の INCR＋TTL 操作で分散リミッタを簡易構築  
3. **メトリクス可視化**  
   - リミッタヒット率、待ち時間、ブロック件数を Prometheus/Grafana で監視し、閾値見直し  
4. **フェイルオーバー設計**  
   - リミットオーバー時のフォールバック動作（キャッシュ応答／Queue への再投入）を定義  
5. **動的設定**  
   - コンフィグストア（Consul, etcd, SSM）と連携し、閾値をリアルタイムに調整可能に  


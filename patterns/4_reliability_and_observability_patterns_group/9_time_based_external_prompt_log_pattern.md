# Time-Based External Prompt Log Pattern

## 概要

Time-Based External Prompt Log Patternは、LLMに送信するプロンプトをアプリケーションログに直接記録するのではなく、外部の時系列ストレージやオブジェクトストレージに保存し、そのURIとタイムスタンプのみをログに記録する設計手法です。このパターンにより、ログサイズを抑えつつ、セキュリティや検索性、保持運用の柔軟性を確保することができます。

## 解決したい課題

LLMを活用するアプリケーションでは、以下のような問題が発生しがちです。

1. **ログ容量の肥大化**
   - プロンプト全文をログに記録すると、トークン数やユーザー数が増えるにつれてストレージ消費が急増します。
   - 例：1日1000件のリクエストで、1プロンプトあたり平均1000トークン使用する場合、月間で約30GBのログ容量が必要になります。

2. **機密情報やPIIの漏洩リスク**
   - ユーザー入力を含むプロンプトをそのままログに保存することで、情報漏洩のリスクが高まります。
   - 例：医療情報や個人情報を含むプロンプトがログに残り、アクセス権限を持つ全ての運用担当者が閲覧可能になってしまいます。

3. **保持ポリシーの柔軟性不足**
   - ログのリテンション設定では、プロンプトごとに異なる保存期間の制御が難しくなります。
   - 例：規制対応が必要なプロンプトは7年間保存が必要ですが、一般的な会話は3ヶ月で十分という要件に対応できません。

4. **検索の非効率性**
   - プロンプト全文を含むログからの検索は高コストで遅延も大きく、運用や分析時の生産性を低下させます。
   - 例：特定のユーザーとの会話履歴を検索する場合、全文検索が必要となり、検索時間が長くなります。

## 解決策

このパターンでは、LLM呼び出し時に生成された完全なプロンプトを、S3、GCS、Elasticsearch、InfluxDBなどの外部ストレージに保存します。そしてアプリケーションログには、その保存先URI（`prompt_uri`）とタイムスタンプのみを記録します。

1. **時系列ベースの保存構造**
   - 例：`s3://prompt-logs/2024/03/15/14/request-123.json`のような形式で保存し、時系列での検索を容易にします。

2. **非同期保存処理**
   - プロンプト保存処理はバックグラウンドで行い、推論レスポンスの速度に影響を与えないようにします。
   - 例：KafkaやRabbitMQなどのメッセージキューを使用して、非同期でプロンプトを保存します。

3. **アクセス制御の実装**
   - 外部ストレージ側で適切なアクセス制御を設定し、必要な権限を持つユーザーのみがプロンプトにアクセスできるようにします。
   - 例：IAMロールやバケットポリシーを使用して、最小権限の原則に基づくアクセス制御を実装します。

## 適応するシーン

このパターンは以下のような場面で特に有効です。

- エンタープライズ向けチャットボットで、高頻度のプロンプト記録と規制対応を両立したい場合
- RAGバッチ処理で、生成されたプロンプトの検証や再利用を行いたい場合
- マルチテナントサービスで、テナントごとに異なるログ保持要件に対応したい場合
- 実験・PoCフェーズでプロンプト改良の効果を後から分析したい場合

## 利用するメリット

このパターンを活用することで、以下のような利点があります。

- ログストレージの使用量を大幅に削減できます。
- セキュリティ面でのリスクを軽減し、外部ストレージ側で適切なアクセス制御が可能になります。
- 外部ストレージのTTLやライフサイクルルールを用いることで、ドメイン要件に応じたデータ保持管理が柔軟に行えます。
- 時系列インデックスにより、特定期間のプロンプトを迅速に検索・調査できます。

## 注意点とトレードオフ

このパターンには以下のような注意点とトレードオフがあります。

- 外部ストレージの可用性に依存するため、障害発生時にプロンプトの取得ができなくなる可能性があります。
- プロンプト保存とURI生成処理により、リクエストパイプラインに若干の遅延（数十〜数百ミリ秒）が発生します。
- 外部ストレージの利用にはPUT/GETやインデックス保持のコストがかかります。
- ストアの監視・運用・ライフサイクル設定やバックアップ体制の整備が必要になります。

## 導入のヒント

導入を円滑に進めるためのポイントは以下の通りです。

1. **非同期処理の活用**
   - プロンプトの保存処理はバックグラウンドで行い、推論レスポンスの性能に影響を与えないようにします。

2. **時系列パーティションの設計**
   - ディレクトリやインデックスを日時ベースで分割し、アクセス効率とコスト効率を高めます。

3. **アクセス制御の徹底**
   - 最小権限のサービスアカウントを用い、監査ログの有効化も併せて行います。

4. **URI命名規則の統一**
   - `/year/month/day/hour/request_id.json` など検索しやすい形式を採用します。

5. **TTLの活用**
   - 各ドメインやテナントの要件に応じて、保存期間を自動管理できるようTTL設定を行います。

## まとめ

Time-Based External Prompt Log Patternは、プロンプトの可観測性とセキュリティ、運用効率のバランスを取るための有効な設計手法です。本番システムや規制対応が必要なサービスにおいて、ログサイズとリスクを抑制しながら、必要なプロンプト履歴を外部ストアで適切に管理・活用することが可能になります。ただし、外部ストレージの可用性やコスト、運用負荷とのバランスを考慮しながら導入を進めることが重要です。

# Circuit Breaker for LLM Calls Pattern

## 説明  
Circuit Breaker for LLM Calls Pattern は、LLM API に対する呼び出しエラーが一定閾値を超えた場合に、新規呼び出しを一時停止（オープン状態）し、システム全体への障害伝播を防止するレジリエンス手法です。  
- **状態管理**：  
  - **Closed**：通常状態。エラー閾値未満なら呼び出しを許可。  
  - **Open**：エラー閾値超過で呼び出しを遮断し、フォールバックまたはエラーを即時返却。  
  - **Half-Open**：一定時間後に少数リクエストを許可し、回復を検証。  
- **閾値設定**：失敗カウント、エラー率、連続エラー数などでトリガを定義  
- **フォールバック**：キャッシュ応答や代替処理への切り替えを組み合わせ  

## 用途  
- **大規模チャットプラットフォーム**：一部モデル障害時に全ユーザへの影響を最小化  
- **バッチ要約／分類ジョブ**：API 側過負荷での無限エラーループを防ぎ、処理完了を保証  
- **エンタープライズ API ゲートウェイ**：複数チームからの呼び出し過多を検知し、トラフィックシェーピング  
- **リアルタイム対話システム**：レスポンスが返らない状況でユーザ体験を守る  

## 解決する課題  
1. **連鎖的障害拡大**  
   - 単一エンドポイント障害が全システムに波及するリスクを防止  
2. **レート制限超過**  
   - リトライループにより API レート制限をさらに悪化させる悪循環を回避  
3. **遅延スパイク**  
   - 長時間ハングした呼び出しが全体レイテンシを押し上げる事態を抑制  
4. **リソース枯渇**  
   - 再試行で無駄なリソース消費が発生し続けるのを防ぎ、安定稼働を維持  

## 対象とするシステム／プロジェクト  
- **SaaS チャット API**：外部 LLM プロバイダ呼び出しの可用性を確保  
- **ドキュメント処理パイプライン**：一時的 API エラーをバッチ処理に吸収  
- **マイクロサービスアーキテクチャ**：サービス間呼び出しのレジリエンス設計  
- **IoT エッジデバイス**：断続的ネットワーク環境下での API 呼び出し管理  

## 利用するメリット  
- **障害孤立**：一部失敗をシステム全体に波及させず、健全部分は継続稼働  
- **自動復旧**：Half-Open フェーズで正常復帰を検知し、自動で Closed 状態へ戻す  
- **コスト制御**：不要なリトライ呼び出しを防ぎ、API 利用コストを抑制  
- **UX 安定化**：フォールバック応答でユーザへの応答遅延やエラー表示を軽減  

## 注意点とトレードオフ  
- **閾値チューニング**  
  - 閾値が厳しすぎると一時的エラーで機能停止、緩すぎると抑止効果が薄い  
- **フォールバック品質**  
  - フォールバック応答の品質が低いと、エラーより悪いユーザ体験を招く恐れ  
- **実装複雑度**  
  - 状態遷移ロジックとメトリクス収集を組み込むコストが発生  
- **監視・アラート**  
  - ブレーカー動作を可視化し、誤検知や過度発動を早期に調整する体制が必要  

## 導入のヒント  
1. **シンプルな閾値から開始**  
   - 連続失敗回数＝3、またはエラー率＝50% を初期値に設定し効果を確認  
2. **メトリクスとログ**  
   - ブレーカー状態遷移、リクエスト数、エラー数を Prometheus/Grafana 等で可視化  
3. **段階的フォールバック**  
   - キャッシュ→簡易応答→完全エラー返却の順に段階的にフォールバック  
4. **テストシナリオ整備**  
   - 正常時／障害時／回復時の各フェーズをユニットテスト・E2E テストでカバー  
5. **ドキュメント化**  
   - ブレーカーの動作モデルと設定値を README に明記し、運用チームと共有  

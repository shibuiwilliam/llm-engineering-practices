# Load Shedding Prompt Throttling Pattern

## 説明  
Load Shedding Prompt Throttling Pattern は、システムが過負荷状態に陥った際に「すべての LLM リクエスト」を一律に遅延させるのではなく、プロンプトの**優先度・重要度**や**リソース使用状況**に応じて動的にスループットを制限（スロットル）し、低優先度リクエストを抑制・切り捨てることで、全体の可用性と高優先度タスクの品質を維持する設計手法です。  
- **優先度分類**：Critical, Standard, Best-Effort などにリクエストを分ける  
- **トークンバケット制御**：各優先度レーンごとにレート制限を設定  
- **バックプレッシャー通知**：HTTP 429 や Retry-After ヘッダでクライアントへ再試行指示  
- **段階的デグレード**：状態に応じて Standard→Best-Effort→Drop の順で制限を強化  

## 用途  
- **リアルタイムチャットボット**：ピーク時に重要業務メッセージのみ優先処理し、雑談リクエストを抑制  
- **バッチジョブキュー**：夜間バッチとオンデマンドレポートを優先度別にスロットル  
- **マルチテナント API**：有料プランと無料プランで呼び出しレートを動的調整  
- **イベントドリブンワークフロー**：緊急アラート系イベントは即時通過、集計系はスロットリング  

## 解決する課題  
1. **過負荷による全体ダウン**  
   - 無制限リクエストで LLM エンジンや自社サービスが飽和し、全ユーザに障害が波及  
2. **コストスパイク**  
   - 突発的バーストで高トークン消費リクエストが集中し、予算を超過  
3. **SLA／QoS維持困難**  
   - 重要リクエストと軽量リクエストを区別せず処理し、業務クリティカルタスクの性能保証が困難  
4. **無駄な再試行増加**  
   - 一律リトライをかけるとリクエストキューがさらに膨張し、システム負荷が持続  

## 対象とするシステム／プロジェクト  
- **オンラインカスタマーサポート**：問い合わせの緊急度に応じて応答優先度を制御  
- **社内ワークフロー自動化**：承認依頼など重要タスクは優先処理、それ以外はバッチ処理  
- **マルチテナント SaaS**：テナント別 SLA に応じたスロットルで公平・効率的にリソース配分  
- **金融アラート配信**：不正検知通知など高優先度イベントを遅延なく配信  

## 利用するメリット  
- **安定性向上**：過負荷下でも最低限の重要リクエストを確実に処理し、全体のダウンを防止  
- **コスト制御**：不必要な高コスト処理を抑え、予算内でサービスを提供  
- **ユーザ体験維持**：重要タスクのみ遅延を回避し、顧客満足度を担保  
- **運用柔軟性**：負荷状況に応じたしきい値調整で、ピーク／閑散期それぞれ最適設定  

## 注意点とトレードオフ  
- **ユーザ切り捨てリスク**  
  - 低優先度リクエストがドロップされると、一部ユーザ体験に影響  
- **ポリシーチューニング負荷**  
  - 優先度分類ルール、レート制限値、しきい値の最適化には継続的な監視と調整が必要  
- **運用の複雑化**  
  - 複数レーンのメトリクス監視やアラート設定、クライアント通知実装など工数増大  
- **遅延バースト**  
  - 一時的なバッファリングで遅延が蓄積し、応答が断続的に高レイテンシになる可能性  

## 導入のヒント  
1. **ピークトラフィック分析**  
   - 過去ログを基にリクエスト分布とボトルネック時間帯を特定し、しきい値を設定  
2. **段階的ロールアウト**  
   - まず Best-Effort レーンのみスロットル→Standard→Critical の順に段階導入  
3. **メトリクス＆アラート整備**  
   - 各レーンのスループット、429 レスポンス率、キュー長を可視化し、閾値超過で通知  
4. **クライアントガイダンス**  
   - 429 エラー時に Retry-After ヘッダを返し、クライアント側に再試行タイミングを指示  
5. **自動シミュレーションテスト**  
   - Chaos Testing で急激な負荷を模擬し、スロットル動作とフォールバック動作を検証  

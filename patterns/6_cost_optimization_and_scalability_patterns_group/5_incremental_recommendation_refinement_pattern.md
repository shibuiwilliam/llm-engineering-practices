# Incremental Recommendation Refinement Pattern

## 説明  
Incremental Recommendation Refinement Pattern は、LLM を使ったレコメンデーションやランキング生成を「一度に最適解を求める」のではなく、段階的に候補を絞り込み・改善していくことで、モデル呼び出し回数とトークン消費を抑えつつ高品質な提案を得る設計手法です。  
- **粗抽出フェーズ**：軽量モデルまたは高速フィルタリングで上位 N 件候補を抽出  
- **段階的絞り込み**：抽出結果を小規模プロンプトで再評価し、上位 M (< N) 件に絞る  
- **最終洗練フェーズ**：上位少数候補に対して詳細プロンプトで質的評価・スコア付け  
- **早期終了**：品質が閾値を超えた候補が見つかれば、それ以上の呼び出しを省略  

## 用途  
- **パーソナライズ商品推薦**：大量アイテムから人気・関連度ベースで候補抽出→ユーザプロファイルで絞り込み→最終説明文生成  
- **コンテンツサジェスト**：記事や動画のレコメンドを大規模コーパスから段階的に最適化  
- **求人マッチング**：求職者プロフィールと求人リストを高速フィルタ→LLM でマッチ度評価→最終おすすめ提示  
- **自動プレゼンテーション構築**：テンプレート候補→スライド構成案→キャプション文生成を段階的に精緻化  

## 解決する課題  
1. **高コストな一括推論**  
   - 数百～数千候補を一度の大規模プロンプトで評価するとトークン消費とレイテンシが膨張  
2. **スケール制約**  
   - リクエスト数と候補数が比例して増えると、バッチ／リアルタイムともに処理が追いつかない  
3. **品質／速度トレードオフ**  
   - 高品質出力を求めると遅延が許容限度を超え、低遅延を優先すると品質が低下  
4. **過剰推薦防止**  
   - 閾値以上の十分な候補が早期に確定すれば、無駄な呼び出しを省けない  

## 対象とするシステム／プロジェクト  
- **大規模 EC レコメンデーション**：数百万アイテムからリアルタイムにトップ提案を生成  
- **動画プラットフォーム**：無限スクロール用のおすすめリストをユーザ行動に応じて段階生成  
- **求人マッチングサービス**：毎日更新される求人と数十万の求職者を動的にマッチ  
- **自動ドキュメント生成ツール**：ドキュメント候補を複数案出し、最も適合度の高い構成を提示  

## 利用するメリット  
- **コスト最適化**：大規模プロンプト呼び出しを最小化し、トークン使用量を大幅削減  
- **応答性向上**：粗抽出フェーズで高速に候補を絞り込み、ユーザ体験を損なわない  
- **品質担保**：最終フェーズで少数候補を詳細評価し、高品質なおすすめを確実に提供  
- **動的調整**：閾値やフェーズ回数を運用中にチューニングし、コストと品質のバランスを最適化  

## 注意点とトレードオフ  
- **複数フェーズ設計コスト**  
  - 抽出・絞り込み・精緻化それぞれのプロンプト・パイプラインを個別設計・テストが必要  
- **早期停止リスク**  
  - 閾値設定が甘いと不十分な候補で終了し、品質低下を招く  
- **レイテンシ非線形性**  
  - フェーズを増やすほど全体レイテンシが累積するので、段階数の最適バランスを見極める  
- **状態管理複雑化**  
  - 各フェーズ間で候補リストやコンテキストを正確に引き継ぐ実装が必要  

## 導入のヒント  
1. **プロトタイプで閾値検証**  
   - 小規模データで各フェーズのヒット率とレイテンシを計測し、適切な N→M→K を決定  
2. **モデル階層活用**  
   - 粗抽出に小型モデル、絞り込みに中型、最終評価に大規模モデルを使い分ける  
3. **キャッシュ併用**  
   - 各フェーズの結果をキャッシュし、同一ユーザや類似クエリで再利用  
4. **並列フェーズ設計**  
   - 絞り込みフェーズは複数候補を並列評価し、最終集約でスコア計算  
5. **モニタリング & アラート**  
   - フェーズごとの呼び出し回数、レイテンシ、品質スコアを可視化し、異常時に通知  

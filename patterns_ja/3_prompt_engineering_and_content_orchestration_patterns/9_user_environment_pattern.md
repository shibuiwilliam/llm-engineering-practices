# User Environment Pattern

## 概要

User Environment Patternは、ユーザのリクエストに含まれる「暗黙の文脈」（タイムゾーン、言語、地域、ユーザ属性、デバイス状況、天気など）を明示的にプロンプトに組み込むことで、LLMの応答をユーザの状況に合わせて最適化する設計手法です。このパターンにより、より自然かつ正確なパーソナライズドな応答が実現可能となります。

## 解決したい課題

LLMは、ユーザのリクエストに対して一般的な応答を生成することが得意ですが、常にユーザの状況や文脈を考慮しているとは限りません。LLMの事前学習には最新の情報やニュースは含まれませんし、もちろんユーザ特有の情報（名前や趣味、住居等）も知りません。しかし最新の情報やユーザの状況を考慮したほうが、より自然で正確な応答が得られることも多々あるでしょう。

ユーザの状況を考慮しないLLMの応答は、以下のような問題を引き起こす可能性があります。

1. **一律な応答による違和感の発生**
   - すべてのユーザに「Good morning!」と返してしまい、深夜のユーザに不快感を与える。
   - 地域に関係なく同じ通貨単位で価格を表示してしまう。

2. **コンテキスト不足による誤った応答**
   - 「今何時？」という質問に、ユーザの現地時刻と異なる時刻で応答してしまう。
   - ユーザの言語設定を無視して、不適切な言語で応答してしまう。

3. **パーソナライズ不足によるユーザ体験の劣化**
   - デバイスの種類に応じた案内をせず、スマートフォンユーザにデスクトップ向け操作を提案してしまう。
   - ユーザの過去の利用履歴を考慮せず、毎回同じ説明を繰り返してしまう。

4. **環境に合わない情報提供による誤解**
   - 現在地の天気が雨にも関わらず、「今日は晴れです」と応答してしまう。
   - ユーザの地域に存在しないサービスや施設を案内してしまう。

## 解決策

User Environment Patternでは、以下のステップで課題を解決します。

1. **環境情報の取得**
   - ユーザの登録情報から、ユーザの言語、地域、タイムゾーン、デバイス、ネットワーク状況、過去の履歴等を収集します。なお、この情報はユーザの同意に基づいて収集する必要があります。

2. **プロンプトへの注入**
   - `system`メッセージまたはテンプレート変数に環境情報を挿入し、応答の生成に活用します。「ユーザは日本在住で、現在の時刻は午後3時です。スマートフォンからアクセスしています。」という情報をプロンプトに含めます。

3. **動的アダプテーション**
   - 地域に応じた言い回しや、時間帯に応じた挨拶、デバイスに応じた説明を自動で切り替えます。
   - 朝の時間帯には「おはようございます」、夜の時間帯には「こんばんは」と適切な挨拶を生成します。

![img](uml/images/user_environment_pattern_sequence.png)

## 適応するシーン

このパターンは以下のようなシーンで有効です。

- グローバル展開する多言語対応チャットボット
- モバイル／IoTデバイス向けの音声・テキストアシスタント
- ユーザの現在地に応じた観光情報・天気・交通案内サービス
- デバイスやOS環境に応じた操作ガイドやトラブルシューティング支援ツール
- ユーザの属性や過去の行動履歴に基づくパーソナライズされたレコメンデーション

## 利用するメリット

このパターンを採用することで、以下のメリットが得られます。

- ユーザごとの文脈に最適化された自然な応答を実現できます。
- コンテキストの整合性を保った正確な情報提供が可能になります。
- パーソナライズにより、ユーザ満足度とエンゲージメントを高めることができます。
- 誤った操作指示や非現実的な提案の防止につながります。
- ユーザの状況に応じた適切な情報の優先順位付けが可能になります。

## 注意点とトレードオフ

このパターンを採用する際は、以下の点に注意が必要です。

- **プライバシーリスク**：位置情報や個人属性を扱うため、データ収集ポリシーやユーザ同意、データ暗号化が必須です。
- **データの鮮度**：タイムゾーンや天気などの情報は動的であり、常に最新情報を取得する必要があります。
- **プロンプトの複雑化**：挿入する環境情報が増えることでテンプレートが複雑化し、保守性が低下します。
- **環境取得の失敗に備えた設計**：フォールバックメッセージやデフォルト値を設ける必要があります。
- **パフォーマンスへの影響**：環境情報の取得と処理により、レスポンスタイムが若干増加する可能性があります。

## 導入のヒント

このパターンを効果的に導入するためのポイントは以下の通りです。

1. まずは「言語」と「タイムゾーン」といった影響の大きい少数の属性から始めることをおすすめします。
2. 環境情報の取得は別モジュール（ミドルウェア、APIなど）に切り出し、プロンプト生成と疎結合に設計します。
3. プロンプトのスニペットをテンプレート化し、環境ごとに切り替え可能な構造にします。
4. プライバシー対策として、必要最小限の情報のみを収集し、同意取得や暗号化処理を徹底します。
5. 環境情報と生成結果をログに記録し、品質の改善やリスク監視に活用します。

## まとめ

User Environment Patternは、ユーザごとの文脈をプロンプトに反映することで、より正確でパーソナライズされたLLMの応答を実現する強力な手法です。プライバシーやシステム設計に配慮しながら、段階的に導入することで、高品質かつユーザフレンドリーなAIアシスタントを構築することが可能になります。

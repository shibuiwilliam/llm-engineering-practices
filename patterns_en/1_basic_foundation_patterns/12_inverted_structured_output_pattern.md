# Inverted Structured Output Pattern

## Overview

The Inverted Structured Output Pattern is a design approach where the LLM itself dynamically generates the desired output format (schema). Instead of humans defining the output format in a fixed manner as in traditional approaches, this pattern has the LLM "inversely" describe and propose the necessary output structure, thereby increasing flexibility and reusability. Through this pattern, the system can generate dynamically adaptable output structures and respond to various domains and requirements.

## Problems to Solve

LLMs can not only generate natural language but also generate programs and prompts. By leveraging this capability of LLMs, it becomes possible to execute automatically generated programs and request prompts within applications, enabling flexible logic implementation.

One challenge in such scenarios is the output format of programs and prompts. While LLM input/output is naturally in natural language by default, applications using LLMs are better suited to handling structured objects (see: **Structured Output Pattern**). Similarly, for programs and prompts generated by LLMs, receiving structured responses makes it possible to run subsequent processes more stably.

- **Unintended Natural Language Processing**
   - Continuously processing unstructured natural language makes it difficult to extract specific items or information from LLM output results.

- **Increased Format Design Effort**
   - Having to manually define different output schemas for multiple domains reduces scalability.

- **Lack of Flexibility**
   - Despite output structures needing to change based on business requirements or input content, being bound to fixed schemas leads to unexpected errors.

## Solution

In this pattern, we instruct the LLM to "define the output schema" and have it automatically generate, for example, Pydantic models or JSON Schema. By using this schema to make another output request, the LLM can return output that conforms to the structure it designed itself.

- We construct a workflow like: `"Please output a Pydantic model representing customer data" → Model structure output → "Please structure the following text according to this model" → JSON output → Initialize as Pydantic model object`.

![img](./uml/images/inverted_structured_output_pattern.png)

## Applicable Scenarios

This pattern is particularly effective in the following situations:

- Use cases where users want to freely define output formats
- Generic data extraction tasks spanning multiple domains and business areas
- Generative applications requiring flexible generation and updates of schemas themselves
- Automatic document generation and structured report creation

## Benefits

Adopting this pattern provides the following benefits:

- Reduces the effort of manual schema design
- Improves reusability of output formats, enabling construction of generic pipelines
- Can dynamically change output structures according to business requirements
- Enables on-the-fly automatic generation of RAG and chatbot response schemas, increasing extensibility

## Considerations and Trade-offs

When adopting this pattern, the following points require attention:

- The schema generated by the LLM might differ from the intended format, requiring verification
- Additional logic is needed to check the consistency between schema and output
- Output stability and reproducibility are slightly lower compared to fixed schema types
- Cases where the LLM over-complicates the output format require control

## Implementation Tips

Key points for effectively implementing this pattern are as follows:

1. It's important to explicitly specify "structural description of the output target" and "schema format (Pydantic, JSON Schema, etc.)" in the prompt.
2. Separate schema generation and data generation into two steps, verifying output quality incrementally.
3. Prepare mechanisms to verify schema and output consistency using Pydantic or JSON Schema validators.
4. A design where the LLM itself performs self-checking of output structure validity is also effective.

## Summary

The Inverted Structured Output Pattern is an approach that achieves high flexibility and scalability by having the LLM itself generate output structures, as opposed to the traditional method of pre-defining schemas. It is particularly effective in applications with diverse domains or systems requiring user customization. However, output quality verification and schema consistency assurance are essential, requiring the use of appropriate verification mechanisms.
